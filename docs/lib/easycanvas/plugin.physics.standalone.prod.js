!function(t,i){for(var e in i)t[e]=i[e]}(window,function(t){var i={};function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var n in t)e.d(s,n,function(i){return t[i]}.bind(null,n));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t["default"]}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=83)}({0:function(t,i,e){"use strict";var s={isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},funcOrValue:function(t,i){return"function"==typeof t?t.call(i,i):t},execFuncs:function(t,i,e){t&&(s.isArray(e)||(e=[e])),"function"==typeof t?t.apply(i,e):s.isArray(t)&&t.length&&t.forEach(function(t){t&&t.apply(i,e)})},blend:["source-over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighter","copy","xor","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],pointInRect:function(t,i,e,s,n,r){return!(t<e||t>s||i<n||i>r)},firstValuable:function(t,i,e){return void 0===t?void 0===i?e:i:t}};t.exports=s},2:function(t,i,e){"use strict";t.exports=function(t,i,e,s,n,r){var o=n?-n/180*3.141593:0,h=t,a=i;return n&&(h=(t-e)*Math.cos(o)-(i-s)*Math.sin(o)+e,a=(t-e)*Math.sin(o)+(i-s)*Math.cos(o)+s),r?[h,a]:{x:h,y:a}}},83:function(t,i,e){t.exports=e(84)},84:function(t,i,e){"use strict";var s=o(e(85)),n=o(e(0)),r=o(e(2));function o(t){return t&&t.__esModule?t:{"default":t}}var h=n["default"].firstValuable,a="undefined"!=typeof window,c=function(t,i,e){return h(t[i][e],t[i])},p=function(t){console.error("[Easycanvas-physics] "+t)},u=s["default"],l=function(t){if(t.physics){var i=this;if(i.physics=i.physics||{},i.physics.shape=i.physics.shape||[],i.physics.gravity=h(i.physics.gravity,2),i.physics.accuracy=h(i.physics.accuracy,2),i.physics.friction=h(i.physics.friction,0),i.physics.elasticity=h(i.physics.elasticity,0),i.physics.group=h(i.physics.group,0),i.physics.collisionType=h(i.physics.collisionType,0),!i.physics["static"]&&i.physics.shape.length){var e;if(i.physics.mass=h(i.physics.mass,0),3===i.physics.shape[0].length)e=u.momentForCircle(i.physics.mass,0,i.physics.shape[0][2],u.vzero);else{var s=i.physics.shape.join(",").split(",").map(function(t,i){var e=Number(t),s=i%2?-e:e;return s||0});e=u.momentForPoly(i.physics.mass,s,u.vzero)}i.physics.moment=h(i.physics.moment,e)}i.launch=b.bind(i),i.physicsOff=function(){return i.$physics?(i.$physics.inSpace=!1,i.$physics.body&&i.$physics.space.removeBody(i.$physics.body),i.$physics.shape.forEach(function(t){i.$physics.space.removeShape(t)}),i.$physics=null,this):this},i.physicsOn=function(){var t=this;return this.$physics||function(t){var i=t.physics;if(i){var e=function a(t){if(t.$parent)return t.$parent.$physics&&t.$parent.$physics.space?t.$parent:a(t.$parent);return null}(t);if(!e)return void p("No physics container found launched.");var s=e.$physics.space;if(t.$physics={space:s},!i.shape.length)return;var n,o=i.shape,h=[];i["static"]||(n=new u.Body(i.mass,i.moment)),o.forEach(function(o,a){var p,l=t.getStyle("left"),f=t.getStyle("top"),b=e.getStyle("left"),v=e.getStyle("top");if(3!==o.length||o[0].length){if(o.length>=3){var d=t.style.rx||t.getRect().left+t.getRect().width/2,_=t.style.ry||t.getRect().top+t.getRect().height/2,x=o.map(function(i){var e=(0,r["default"])(i[0]+l-b,i[1]+f+v,d-b,_+v,t.style.rotate||0);return[e.x-l,e.y-f]}).join(",").split(",").map(function(t,i){var e=Number(t),s=i%2?-e:e;return s||0}),g=n?u.vzero:{x:l-b,y:-f+v};p=new u.PolyShape(n||s.staticBody,x,g)}else if(2===o.length){var m=t.style.rx||t.getRect().left+t.getRect().width/2,w=t.style.ry||t.getRect().top+t.getRect().height/2,S=(0,r["default"])(o[0][0]+l-b,o[0][1]+f+v,m-b,w+v,t.style.rotate||0),A=(0,r["default"])(o[1][0]+l-b,o[1][1]+f+v,m-b,w+v,t.style.rotate||0);S.x-=l,S.y-=f,A.x-=l,A.y-=f,p=new u.SegmentShape(s.staticBody,y(S),y(A),0)}}else{var j=n?u.vzero:{x:l-b,y:-f+v};p=new u.CircleShape(n||s.staticBody,o[2],j)}p.setFriction(c(i,"friction",a)),p.setElasticity(c(i,"elasticity",a)),p.setCollisionType(c(i,"collisionType",a)),p.group=c(i,"group",a),p.$sprite=t,h.push(p)}),t.$physics.body=n,t.$physics.shape=h,n&&(n.$sprite=t)}}(this),this.$physics?(this.$physics.inSpace=!0,this.$physics.body&&this.$physics.body.setPos(new u.Vect(this.getRect().left+this.getRect().width/2,-this.getRect().top-this.getRect().height/2)),this.$physics.body&&this.$physics.space.addBody(this.$physics.body),this.$physics.shape&&this.$physics.shape.forEach(function(i){t.$physics.space[t.physics["static"]?"addStaticShape":"addShape"](i)}),this.children.forEach(function(i){t.physicsOn.call(i)}),this):this},i.physicsSetVelocity=function(t){if(i.$physics)return i.$physics.body?(i.$physics.body.setVel({x:t.x,y:-t.y}),this):this},i.physicsGetVelocity=function(){if(i.$physics){if(!i.$physics.body)return this;var t=i.$physics.body.getVel();return t.y=-t.y,t}},i.physicsApplyImpulse=function(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{x:0,y:0},e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{x:0,y:0};if(i.$physics)return i.$physics.body?(t.y=-t.y,e.y=-e.y,i.$physics.body.applyImpulse(t,e),this):this},i.physicsGetAngelVelocity=function(){if(i.$physics)return i.$physics.body?i.$physics.body.getAngVel():this},i.physicsSetAngelVelocity=function(t){if(i.$physics)return i.$physics.body?(i.$physics.body.setVel(t),this):this},i.physicsApplyForce=function(t){arguments.length>1&&arguments[1]!==undefined&&arguments[1];return i.$physics&&i.$physics.body?(i.$physics.body.applyForce({x:t.x,y:-t.y},{x:t.x,y:t.y}),this):this},i.physicsResetForces=function(){return i.$physics.body.resetForces(),this},i.on("beforeTick",function(t){i.$physics&&i.physics&&(i.physics["static"]||!1!==i.$physics.inSpace&&i.$physics.body&&f(i.$physics.body,i))})}},y=function(t){return new u.Vect(t.x,t.y?-t.y:0)},f=function(t,i){var e=t.getPos();t.getVel();i.style.rotate=180*t.a/Math.PI,i.style.left=e.x,i.style.top=-e.y,"lt"===i.style.locate?(i.style.left-=i.getRect().width/2,i.style.top-=i.getRect().height/2):"ld"===i.style.locate?(i.style.left-=i.getRect().width/2,i.style.top+=i.getRect().height/2):"rd"===i.style.locate?(i.style.left+=i.getRect().width/2,i.style.top+=i.getRect().height/2):"rt"===i.style.locate&&(i.style.left+=i.getRect().width/2,i.style.top-=i.getRect().height/2)};function b(){var t=new u.Space;t.gravity=new u.Vect(0,-500*this.physics.gravity),this.on("beforeTick",function(i){for(var e=.01*(this.$canvas.maxFps>0?this.$canvas.maxFps:60)/60,s=0;s<this.physics.accuracy;s++)t.step(e)}),this.$physics={space:t};var i=function(i){return function(e){var s=e.a.$sprite.trigger(i,e.b.$sprite,e.b.$sprite.physics.collisionType,e,t),n=e.b.$sprite.trigger(i,e.a.$sprite,e.a.$sprite.physics.collisionType,e,t);return!(s||n)}};return t.setDefaultCollisionHandler(i("physicsCollisionBegin"),i("physicsCollisionPreSolve"),i("physicsCollisionPostSolve"),i("physicsCollisionSeparate")),t.$sprite=this,t}a&&window.Easycanvas?Easycanvas.extend(l):t.exports=l},85:function(t,i,e){"use strict";function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}!function(){var t;Object.create=Object.create||function(t){function i(){}return i.prototype=t,new i},t=i;var e,n;"object"===("undefined"==typeof window?"undefined":s(window))&&window.navigator.userAgent.indexOf("Firefox")>-1?(e=Math.min,n=Math.max):(e=function(t,i){return t<i?t:i},n=function(t,i){return t>i?t:i});var r=function(t,i){return t<i?t+" "+i:i+" "+t},o=function(t,i){for(var e=0;e<t.length;e++)if(t[e]===i)return t[e]=t[t.length-1],void t.length--};t.momentForCircle=function(t,i,e,s){return t*(.5*(i*i+e*e)+M(s))},t.areaForCircle=function(t,i){return Math.PI*Math.abs(t*t-i*i)},t.momentForSegment=function(t,i,e){var s=m(_(i,e),.5);return t*(R(e,i)/12+M(s))},t.areaForSegment=function(t,i,e){return e*(Math.PI*e+2*F(t,i))},t.momentForPoly=function(t,i,e){for(var s=0,n=0,r=i.length,o=0;o<r;o+=2){var h=i[o]+e.x,a=i[o+1]+e.y,c=i[(o+2)%r]+e.x,p=i[(o+3)%r]+e.y,u=S(c,p,h,a);s+=u*(b(h,a,h,a)+b(h,a,c,p)+b(c,p,c,p)),n+=u}return t*s/(6*n)},t.areaForPoly=function(t){for(var i=0,e=0,s=t.length;e<s;e+=2)i+=w(new l(t[e],t[e+1]),new l(t[(e+2)%s],t[(e+3)%s]));return-i/2},t.centroidForPoly=function(t){for(var i=0,e=new l(0,0),s=0,n=t.length;s<n;s+=2){var r=new l(t[s],t[s+1]),o=new l(t[(s+2)%n],t[(s+3)%n]),h=w(r,o);i+=h,e=_(e,m(_(r,o),h))}return m(e,1/(3*i))},t.recenterPoly=function(i){for(var e=t.centroidForPoly(i),s=0;s<i.length;s+=2)i[s]-=e.x,i[s+1]-=e.y},t.momentForBox=function(t,i,e){return t*(i*i+e*e)/12},t.momentForBox2=function(i,e){var s=e.r-e.l,n=e.t-e.b,r=m([e.l+e.r,e.b+e.t],.5);return t.momentForBox(i,s,n)+i*M(r)};var h=t.loopIndexes=function(t){var i,e,s,n,r=0,o=0;i=s=t[0],e=n=t[1];for(var h=t.length>>1,a=1;a<h;a++){var c=t[2*a],p=t[2*a+1];c<i||c==i&&p<e?(i=c,e=p,r=a):(c>s||c==s&&p>n)&&(s=c,n=p,o=a)}return[r,o]},a=function(t,i,e){var s=t[2*i];t[2*i]=t[2*e],t[2*e]=s,s=t[2*i+1],t[2*i+1]=t[2*e+1],t[2*e+1]=s},c=function(t,i,e,s,n,r){if(0===e)return 0;for(var o=0,h=i,c=x(n,s),p=r*v(c),u=i,y=i+e-1;u<=y;){var f=new l(t[2*u],t[2*u+1]),b=w(c,x(f,s));b>p?(b>o&&(o=b,h=u),u++):(a(t,u,y),y--)}return h!=i&&a(t,i,h),u-i};t.convexHull=function(t,i,e){if(i)for(var s=0;s<t.length;s++)i[s]=t[s];else i=t;var n=h(t),r=n[0],o=n[1];if(r==o)return i.length=2,i;a(i,0,r),a(i,1,0==o?r:o);var p=new l(i[0],i[1]),u=new l(i[2],i[3]),y=function f(t,i,e,s,n,r,o,h){if(s<0)return 0;if(0==s)return i[2*h]=r.x,i[2*h+1]=r.y,1;var a=c(i,e,s,n,r,t),p=f(t,i,e+1,a-1,n,new l(i[2*e],i[2*e+1]),r,h),u=h+p++;return i[2*u]=r.x,i[2*u+1]=r.y,p+f(t,i,e+a+1,c(i,e+a,s-a,r,o,t)-1,r,new l(i[2*(e+a)],i[2*(e+a)+1]),o,h+p)}(e,i,2,(t.length>>1)-2,p,u,p,1)+1;return i.length=2*y,J(i),i};var p=function(t,i,s){return e(n(t,i),s)},u=function(t){return n(0,e(t,1))},l=t.Vect=function(t,i){this.x=t,this.y=i};t.v=function(t,i){return new l(t,i)};var y=t.vzero=new l(0,0),f=t.v.dot=function(t,i){return t.x*i.x+t.y*i.y},b=function(t,i,e,s){return t*e+i*s},v=t.v.len=function(t){return Math.sqrt(f(t,t))},d=t.v.len2=function(t,i){return Math.sqrt(t*t+i*i)},_=(t.v.eql=function(t,i){return t.x===i.x&&t.y===i.y},t.v.add=function(t,i){return new l(t.x+i.x,t.y+i.y)});l.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this};var x=t.v.sub=function(t,i){return new l(t.x-i.x,t.y-i.y)};l.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this};var g=t.v.neg=function(t){return new l(-t.x,-t.y)};l.prototype.neg=function(){return this.x=-this.x,this.y=-this.y,this};var m=t.v.mult=function(t,i){return new l(t.x*i,t.y*i)};l.prototype.mult=function(t){return this.x*=t,this.y*=t,this};var w=t.v.cross=function(t,i){return t.x*i.y-t.y*i.x},S=function(t,i,e,s){return t*s-i*e},A=t.v.perp=function(t){return new l(-t.y,t.x)},j=(t.v.pvrperp=function(t){return new l(t.y,-t.x)},t.v.project=function(t,i){return m(i,f(t,i)/M(i))});l.prototype.project=function(t){return this.mult(f(this,t)/M(t)),this};var B=t.v.rotate=function(t,i){return new l(t.x*i.x-t.y*i.y,t.x*i.y+t.y*i.x)};l.prototype.rotate=function(t){return this.x=this.x*t.x-this.y*t.y,this.y=this.x*t.y+this.y*t.x,this};var I=t.v.unrotate=function(t,i){return new l(t.x*i.x+t.y*i.y,t.y*i.x-t.x*i.y)},M=t.v.lengthsq=function(t){return f(t,t)},C=t.v.lengthsq2=function(t,i){return t*t+i*i},k=t.v.lerp=function(t,i,e){return _(m(t,1-e),m(i,e))},P=t.v.normalize=function(t){return m(t,1/v(t))},L=t.v.normalize_safe=function(t){return 0===t.x&&0===t.y?y:P(t)},$=t.v.clamp=function(t,i){return f(t,t)>i*i?m(P(t),i):t},F=(t.v.lerpconst=function(t,i,e){return _(t,$(x(i,t),e))},t.v.dist=function(t,i){return v(x(t,i))}),R=t.v.distsq=function(t,i){return M(x(t,i))},V=(t.v.near=function(t,i,e){return R(t,i)<e*e},t.v.slerp=function(t,i,e){var s=Math.acos(f(t,i));if(s){var n=1/Math.sin(s);return _(m(t,Math.sin((1-e)*s)*n),m(i,Math.sin(e*s)*n))}return t}),O=(t.v.slerpconst=function(t,i,s){var n=Math.acos(f(t,i));return V(t,i,e(s,n)/n)},t.v.forangle=function(t){return new l(Math.cos(t),Math.sin(t))},t.v.toangle=function(t){return Math.atan2(t.y,t.x)},t.v.str=function(t){return"("+t.x.toFixed(3)+", "+t.y.toFixed(3)+")"},t.BB=function(t,i,e,s){this.l=t,this.b=i,this.r=e,this.t=s,0});t.bb=function(t,i,e,s){return new O(t,i,e,s)};var N=function(t,i){return new O(t.x-i,t.y-i,t.x+i,t.y+i)},T=0,Q=(t.NO_GROUP=0,t.ALL_LAYERS=-1);t.resetShapeIdCounter=function(){T=0};var q=t.Shape=function(t){this.body=t,this.bb_l=this.bb_b=this.bb_r=this.bb_t=0,this.hashid=T++,this.sensor=!1,this.e=0,this.u=0,this.surface_v=y,this.collision_type=0,this.group=0,this.layers=Q,this.space=null,this.collisionCode=this.collisionCode};q.prototype.setElasticity=function(t){this.e=t},q.prototype.setFriction=function(t){this.body.activate(),this.u=t},q.prototype.setLayers=function(t){this.body.activate(),this.layers=t},q.prototype.setSensor=function(t){this.body.activate(),this.sensor=t},q.prototype.setCollisionType=function(t){this.body.activate(),this.collision_type=t},q.prototype.getBody=function(){return this.body},q.prototype.active=function(){return this.body&&-1!==this.body.shapeList.indexOf(this)},q.prototype.setBody=function(t){this.active(),this.body=t},q.prototype.cacheBB=function(){return this.update(this.body.p,this.body.rot)},q.prototype.update=function(t,i){isNaN(i.x),isNaN(t.x),this.cacheData(t,i)},q.prototype.pointQuery=function(t){var i=this.nearestPointQuery(t);if(i.d<0)return i},q.prototype.getBB=function(){return new O(this.bb_l,this.bb_b,this.bb_r,this.bb_t)};var H=function(t,i,e){this.shape=t,this.p=i,this.d=e},E=function(t,i,e){this.shape=t,this.t=i,this.n=e};E.prototype.hitPoint=function(t,i){return k(t,i,this.t)},E.prototype.hitDist=function(t,i){return F(t,i)*this.t};var D=t.CircleShape=function(t,i,e){this.c=this.tc=e,this.r=i,this.type="circle",q.call(this,t)};D.prototype=Object.create(q.prototype),D.prototype.cacheData=function(t,i){var e=this.tc=B(this.c,i).add(t),s=this.r;this.bb_l=e.x-s,this.bb_b=e.y-s,this.bb_r=e.x+s,this.bb_t=e.y+s},D.prototype.nearestPointQuery=function(t){var i=t.x-this.tc.x,e=t.y-this.tc.y,s=d(i,e),n=this.r,r=new l(this.tc.x+i*n/s,this.tc.y+e*n/s);return new H(this,r,s-n)};var G=function(t,i,e,s,n,r){s=x(s,i),n=x(n,i);var o=f(s,s)-2*f(s,n)+f(n,n),h=-2*f(s,s)+2*f(s,n),a=h*h-4*o*(f(s,s)-e*e);if(a>=0){var c=(-h-Math.sqrt(a))/(2*o);if(0<=c&&c<=1)return new E(t,c,P(k(s,n,c)))}};D.prototype.segmentQuery=function(t,i){return G(this,this.tc,this.r,t,i)};var z=t.SegmentShape=function(t,i,e,s){this.a=i,this.b=e,this.n=A(P(x(e,i))),this.ta=this.tb=this.tn=null,this.r=s,this.a_tangent=y,this.b_tangent=y,this.type="segment",q.call(this,t)};z.prototype=Object.create(q.prototype),z.prototype.cacheData=function(t,i){var e,s,n,r;this.ta=_(t,B(this.a,i)),this.tb=_(t,B(this.b,i)),this.tn=B(this.n,i),this.ta.x<this.tb.x?(e=this.ta.x,s=this.tb.x):(e=this.tb.x,s=this.ta.x),this.ta.y<this.tb.y?(n=this.ta.y,r=this.tb.y):(n=this.tb.y,r=this.ta.y);var o=this.r;this.bb_l=e-o,this.bb_b=n-o,this.bb_r=s+o,this.bb_t=r+o},z.prototype.nearestPointQuery=function(t){var i=function(t,i,e){var s=x(i,e),n=u(f(s,x(t,e))/M(s));return _(e,m(s,n))}(t,this.ta,this.tb),e=t.x-i.x,s=t.y-i.y,n=d(e,s),r=this.r,o=n?_(i,m(new l(e,s),r/n)):i;return new H(this,o,n-r)},z.prototype.segmentQuery=function(t,i){var e=this.tn,s=f(x(this.ta,t),e),n=this.r,r=s>0?g(e):e,o=x(m(r,n),t),h=_(this.ta,o),a=_(this.tb,o),c=x(i,t);if(w(c,h)*w(c,a)<=0){var p=s+(s>0?-n:n),u=-p,l=f(c,e)-p;if(u*l<0)return new E(this,u/(u-l),r)}else if(0!==n){var y=G(this,this.ta,this.r,t,i),b=G(this,this.tb,this.r,t,i);return y?b&&b.t<y.t?b:y:b}},z.prototype.setNeighbors=function(t,i){this.a_tangent=x(t,this.a),this.b_tangent=x(i,this.b)},z.prototype.setEndpoints=function(t,i){this.a=t,this.b=i,this.n=A(P(x(i,t)))};var J=function(t){for(var i=t.length,e=0;e<i;e+=2){var s=t[e],n=t[e+1],r=t[(e+2)%i],o=t[(e+3)%i],h=t[(e+4)%i],a=t[(e+5)%i];if(S(r-s,o-n,h-r,a-o)>0)return!1}return!0},W=t.PolyShape=function(t,i,e){this.setVerts(i,e),this.type="poly",q.call(this,t)};W.prototype=Object.create(q.prototype);var U=function(t,i){this.n=t,this.d=i};U.prototype.compare=function(t){return f(this.n,t)-this.d},W.prototype.setVerts=function(t,i){t.length,t[0],J(t);var e=t.length,s=e>>1;this.verts=new Array(e),this.tVerts=new Array(e),this.planes=new Array(s),this.tPlanes=new Array(s);for(var n=0;n<e;n+=2){var r=t[n]+i.x,o=t[n+1]+i.y,h=t[(n+2)%e]+i.x,a=t[(n+3)%e]+i.y,c=P(A(new l(h-r,a-o)));this.verts[n]=r,this.verts[n+1]=o,this.planes[n>>1]=new U(c,b(c.x,c.y,r,o)),this.tPlanes[n>>1]=new U(new l(0,0),0)}};t.BoxShape=function(t,i,e){var s=i/2,n=e/2;return K(t,new O(-s,-n,s,n))};var K=t.BoxShape2=function(t,i){var e=[i.l,i.b,i.l,i.t,i.r,i.t,i.r,i.b];return new W(t,e,y)};W.prototype.transformVerts=function(t,i){for(var s=this.verts,r=this.tVerts,o=Infinity,h=-Infinity,a=Infinity,c=-Infinity,p=0;p<s.length;p+=2){var u=s[p],l=s[p+1],y=t.x+u*i.x-l*i.y,f=t.y+u*i.y+l*i.x;r[p]=y,r[p+1]=f,o=e(o,y),h=n(h,y),a=e(a,f),c=n(c,f)}this.bb_l=o,this.bb_b=a,this.bb_r=h,this.bb_t=c},W.prototype.transformAxes=function(t,i){for(var e=this.planes,s=this.tPlanes,n=0;n<e.length;n++){var r=B(e[n].n,i);s[n].n=r,s[n].d=f(t,r)+e[n].d}},W.prototype.cacheData=function(t,i){this.transformAxes(t,i),this.transformVerts(t,i)},W.prototype.nearestPointQuery=function(t){for(var i,e,s,n,r,o,h,a=this.tPlanes,c=this.tVerts,p=c[c.length-2],f=c[c.length-1],v=Infinity,d=y,_=!1,x=0;x<a.length;x++){a[x].compare(t)>0&&(_=!0);var g=c[2*x],m=c[2*x+1],w=(i=t.x,e=t.y,r=void 0,o=void 0,h=void 0,h=u(b(r=p-(s=g),o=f-(n=m),i-s,e-n)/C(r,o)),new l(s+r*h,n+o*h)),S=F(t,w);S<v&&(v=S,d=w),p=g,f=m}return new H(this,d,_?v:-v)},W.prototype.segmentQuery=function(t,i){for(var e=this.tPlanes,s=this.tVerts,n=e.length,r=2*n,o=0;o<n;o++){var h=e[o].n,a=f(t,h);if(!(e[o].d>a)){var c=f(i,h),p=(e[o].d-a)/(c-a);if(!(p<0||1<p)){var u=k(t,i,p),l=-w(h,u),y=-S(h.x,h.y,s[2*o],s[2*o+1]),b=-S(h.x,h.y,s[(2*o+2)%r],s[(2*o+3)%r]);if(y<=l&&l<=b)return new E(this,p,h)}}}},W.prototype.valueOnAxis=function(t,i){for(var s=this.tVerts,n=b(t.x,t.y,s[0],s[1]),r=2;r<s.length;r+=2)n=e(n,b(t.x,t.y,s[r],s[r+1]));return n-i},W.prototype.containsVert=function(t,i){for(var e=this.tPlanes,s=0;s<e.length;s++){var n=e[s].n;if(b(n.x,n.y,t,i)-e[s].d>0)return!1}return!0},W.prototype.containsVertPartial=function(t,i,e){for(var s=this.tPlanes,n=0;n<s.length;n++){var r=s[n].n;if(!(f(r,e)<0))if(b(r.x,r.y,t,i)-s[n].d>0)return!1}return!0},W.prototype.getNumVerts=function(){return this.verts.length/2},W.prototype.getVert=function(t){return new l(this.verts[2*t],this.verts[2*t+1])};var Y=t.Body=function(t,i){this.p=new l(0,0),this.vx=this.vy=0,this.f=new l(0,0),this.w=0,this.t=0,this.v_limit=Infinity,this.w_limit=Infinity,this.v_biasx=this.v_biasy=0,this.w_bias=0,this.space=null,this.shapeList=[],this.arbiterList=null,this.constraintList=null,this.nodeRoot=null,this.nodeNext=null,this.nodeIdleTime=0,this.setMass(t),this.setMoment(i),this.rot=new l(0,0),this.setAngle(0)};if("undefined"!=typeof DEBUG&&DEBUG){var X=function(t,i){!function(t,i){t.x==t.x&&(t.y,t.y)}(t),function(t,i){Math.abs(t.x)!==Infinity&&(Math.abs(t.y),Infinity)}(t)};Y.prototype.sanityCheck=function(){this.m==this.m&&(this.m_inv,this.m_inv),this.i==this.i&&(this.i_inv,this.i_inv),X(this.p),X(this.f),this.vx==this.vx&&(Math.abs(this.vx),Infinity),this.vy==this.vy&&(Math.abs(this.vy),Infinity),this.a==this.a&&(Math.abs(this.a),Infinity),this.w==this.w&&(Math.abs(this.w),Infinity),this.t==this.t&&(Math.abs(this.t),Infinity),X(this.rot),this.v_limit,this.v_limit,this.w_limit,this.w_limit}}else Y.prototype.sanityCheck=function(){};Y.prototype.getPos=function(){return this.p},Y.prototype.getVel=function(){return new l(this.vx,this.vy)},Y.prototype.getAngVel=function(){return this.w},Y.prototype.isSleeping=function(){return null!==this.nodeRoot},Y.prototype.isStatic=function(){return this.nodeIdleTime===Infinity},Y.prototype.isRogue=function(){return null===this.space},Y.prototype.setMass=function(t){this.activate(),this.m=t,this.m_inv=1/t},Y.prototype.setMoment=function(t){this.activate(),this.i=t,this.i_inv=1/t},Y.prototype.addShape=function(t){this.shapeList.push(t)},Y.prototype.removeShape=function(t){o(this.shapeList,t)};Y.prototype.removeConstraint=function(t){this.constraintList=function i(t,e,s){return t===s?t.next(e):(t.a===e?t.next_a=i(t.next_a,e,s):t.next_b=i(t.next_b,e,s),t)}(this.constraintList,this,t)},Y.prototype.setPos=function(i){this.activate(),this.sanityCheck(),i===y&&(i=t.v(0,0)),this.p=i},Y.prototype.setVel=function(t){this.activate(),this.vx=t.x,this.vy=t.y},Y.prototype.setAngVel=function(t){this.activate(),this.w=t},Y.prototype.setAngleInternal=function(t){isNaN(t),this.a=t,this.rot.x=Math.cos(t),this.rot.y=Math.sin(t)},Y.prototype.setAngle=function(t){this.activate(),this.sanityCheck(),this.setAngleInternal(t)},Y.prototype.velocity_func=function(t,i,e){var s=this.vx*i+(t.x+this.f.x*this.m_inv)*e,n=this.vy*i+(t.y+this.f.y*this.m_inv)*e,r=this.v_limit,o=s*s+n*n,h=o>r*r?r/Math.sqrt(o):1;this.vx=s*h,this.vy=n*h;var a=this.w_limit;this.w=p(this.w*i+this.t*this.i_inv*e,-a,a),this.sanityCheck()},Y.prototype.position_func=function(t){this.p.x+=(this.vx+this.v_biasx)*t,this.p.y+=(this.vy+this.v_biasy)*t,this.setAngleInternal(this.a+(this.w+this.w_bias)*t),this.v_biasx=this.v_biasy=0,this.w_bias=0,this.sanityCheck()},Y.prototype.resetForces=function(){this.activate(),this.f=new l(0,0),this.t=0},Y.prototype.applyForce=function(t,i){this.activate(),this.f=_(this.f,t),this.t+=w(i,t)},Y.prototype.applyImpulse=function(t,i){this.activate(),Vt(this,t.x,t.y,i)},Y.prototype.getVelAtPoint=function(t){return _(new l(this.vx,this.vy),m(A(t),this.w))},Y.prototype.getVelAtWorldPoint=function(t){return this.getVelAtPoint(x(t,this.p))},Y.prototype.getVelAtLocalPoint=function(t){return this.getVelAtPoint(B(t,this.rot))},Y.prototype.eachShape=function(t){for(var i=0,e=this.shapeList.length;i<e;i++)t(this.shapeList[i])},Y.prototype.eachConstraint=function(t){for(var i=this.constraintList;i;){var e=i.next(this);t(i),i=e}},Y.prototype.eachArbiter=function(t){for(var i=this.arbiterList;i;){var e=i.next(this);i.swappedColl=this===i.body_b,t(i),i=e}},Y.prototype.local2World=function(t){return _(this.p,B(t,this.rot))},Y.prototype.world2Local=function(t){return I(x(t,this.p),this.rot)},Y.prototype.kineticEnergy=function(){var t=this.vx*this.vx+this.vy*this.vy,i=this.w*this.w;return(t?t*this.m:0)+(i?i*this.i:0)};var Z=t.SpatialIndex=function(t){if(this.staticIndex=t,t){if(t.dynamicIndex)throw new Error("This static index is already associated with a dynamic index.");t.dynamicIndex=this}};Z.prototype.collideStatic=function(t,i){if(t.count>0){var e=t.query;this.each(function(t){e.call(t,new O(t.bb_l,t.bb_b,t.bb_r,t.bb_t),i)})}};var tt=t.BBTree=function(t){Z.call(this,t),this.velocityFunc=null,this.leaves={},this.count=0,this.root=null,this.pooledNodes=null,this.pooledPairs=null,this.stamp=0};tt.prototype=Object.create(Z.prototype);var it=function(t,i,s){this.obj=null,this.bb_l=e(i.bb_l,s.bb_l),this.bb_b=e(i.bb_b,s.bb_b),this.bb_r=n(i.bb_r,s.bb_r),this.bb_t=n(i.bb_t,s.bb_t),this.parent=null,this.setA(i),this.setB(s)};tt.prototype.makeNode=function(t,i){var e=this.pooledNodes;return e?(this.pooledNodes=e.parent,e.constructor(this,t,i),e):(0,new it(this,t,i))};var et=function(t,i){this.obj=i,t.getBB(i,this),this.parent=null,this.stamp=1,this.pairs=null,0};tt.prototype.getBB=function(t,i){var s=this.velocityFunc;if(s){var r=.1*(t.bb_r-t.bb_l),o=.1*(t.bb_t-t.bb_b),h=m(s(t),.1);i.bb_l=t.bb_l+e(-r,h.x),i.bb_b=t.bb_b+e(-o,h.y),i.bb_r=t.bb_r+n(r,h.x),i.bb_t=t.bb_t+n(o,h.y)}else i.bb_l=t.bb_l,i.bb_b=t.bb_b,i.bb_r=t.bb_r,i.bb_t=t.bb_t},tt.prototype.getStamp=function(){var t=this.dynamicIndex;return t&&t.stamp?t.stamp:this.stamp},tt.prototype.incrementStamp=function(){this.dynamicIndex&&this.dynamicIndex.stamp?this.dynamicIndex.stamp++:this.stamp++};var st=function(t,i,e,s){this.prevA=null,this.leafA=t,this.nextA=i,this.prevB=null,this.leafB=e,this.nextB=s};tt.prototype.makePair=function(t,i,e,s){var n=this.pooledPairs;return n?(this.pooledPairs=n.prevA,n.prevA=null,n.leafA=t,n.nextA=i,n.prevB=null,n.leafB=e,n.nextB=s,n):(0,new st(t,i,e,s))},st.prototype.recycle=function(t){this.prevA=t.pooledPairs,t.pooledPairs=this};var nt=function(t,i,e){e&&(e.leafA===i?e.prevA=t:e.prevB=t),t?t.leafA===i?t.nextA=e:t.nextB=e:i.pairs=e};et.prototype.clearPairs=function(t){var i,e=this.pairs;for(this.pairs=null;e;)e.leafA===this?(i=e.nextA,nt(e.prevB,e.leafB,e.nextB)):(i=e.nextB,nt(e.prevA,e.leafA,e.nextA)),e.recycle(t),e=i};var rt=function(t,i,e){var s=t.pairs,n=i.pairs,r=e.makePair(t,s,i,n);t.pairs=i.pairs=r,s&&(s.leafA===t?s.prevA=r:s.prevB=r),n&&(n.leafA===i?n.prevA=r:n.prevB=r)};it.prototype.recycle=function(t){this.parent=t.pooledNodes,t.pooledNodes=this},et.prototype.recycle=function(t){},it.prototype.setA=function(t){this.A=t,t.parent=this},it.prototype.setB=function(t){this.B=t,t.parent=this},et.prototype.isLeaf=!0,it.prototype.isLeaf=!1,it.prototype.otherChild=function(t){return this.A==t?this.B:this.A},it.prototype.replaceChild=function(t,i,s){t==this.A||this.B,this.A==t?(this.A.recycle(s),this.setA(i)):(this.B.recycle(s),this.setB(i));for(var r=this;r;r=r.parent){var o=r.A,h=r.B;r.bb_l=e(o.bb_l,h.bb_l),r.bb_b=e(o.bb_b,h.bb_b),r.bb_r=n(o.bb_r,h.bb_r),r.bb_t=n(o.bb_t,h.bb_t)}},it.prototype.bbArea=et.prototype.bbArea=function(){return(this.bb_r-this.bb_l)*(this.bb_t-this.bb_b)};var ot=function(t,i){return(n(t.bb_r,i.bb_r)-e(t.bb_l,i.bb_l))*(n(t.bb_t,i.bb_t)-e(t.bb_b,i.bb_b))},ht=function(t,i){return Math.abs(t.bb_l+t.bb_r-i.bb_l-i.bb_r)+Math.abs(t.bb_b+t.bb_t-i.bb_b-i.bb_t)},at=function si(t,i,s){if(null==t)return i;if(t.isLeaf)return s.makeNode(i,t);var r=t.B.bbArea()+ot(t.A,i),o=t.A.bbArea()+ot(t.B,i);return r===o&&(r=ht(t.A,i),o=ht(t.B,i)),o<r?t.setB(si(t.B,i,s)):t.setA(si(t.A,i,s)),t.bb_l=e(t.bb_l,i.bb_l),t.bb_b=e(t.bb_b,i.bb_b),t.bb_r=n(t.bb_r,i.bb_r),t.bb_t=n(t.bb_t,i.bb_t),t};it.prototype.intersectsBB=et.prototype.intersectsBB=function(t){return this.bb_l<=t.r&&t.l<=this.bb_r&&this.bb_b<=t.t&&t.b<=this.bb_t};var ct=function(t,i,s){var r=1/(s.x-i.x),o=t.bb_l==i.x?-Infinity:(t.bb_l-i.x)*r,h=t.bb_r==i.x?Infinity:(t.bb_r-i.x)*r,a=e(o,h),c=n(o,h),p=1/(s.y-i.y),u=t.bb_b==i.y?-Infinity:(t.bb_b-i.y)*p,l=t.bb_t==i.y?Infinity:(t.bb_t-i.y)*p,y=e(u,l),f=n(u,l);if(y<=c&&a<=f){var b=n(a,y);if(0<=e(c,f)&&b<=1)return n(b,0)}return Infinity};tt.prototype.subtreeRecycle=function(t){t.isLeaf&&(this.subtreeRecycle(t.A),this.subtreeRecycle(t.B),t.recycle(this))};var pt=function(t,i,e){if(i==t)return null;var s=i.parent;if(s==t){var n=t.otherChild(i);return n.parent=t.parent,t.recycle(e),n}return s.parent.replaceChild(s,s.otherChild(i),e),t},ut=function(t,i){return t.bb_l<=i.bb_r&&i.bb_l<=t.bb_r&&t.bb_b<=i.bb_t&&i.bb_b<=t.bb_t};et.prototype.markLeafQuery=function(t,i,e,s){ut(t,this)&&(i?rt(t,this,e):(this.stamp<t.stamp&&rt(this,t,e),s&&s(t.obj,this.obj)))},it.prototype.markLeafQuery=function(t,i,e,s){ut(t,this)&&(this.A.markLeafQuery(t,i,e,s),this.B.markLeafQuery(t,i,e,s))},et.prototype.markSubtree=function(t,i,e){if(this.stamp==t.getStamp()){i&&i.markLeafQuery(this,!1,t,e);for(var s=this;s.parent;s=s.parent)s==s.parent.A?s.parent.B.markLeafQuery(this,!0,t,e):s.parent.A.markLeafQuery(this,!1,t,e)}else for(var n=this.pairs;n;)this===n.leafB?(e&&e(n.leafA.obj,this.obj),n=n.nextB):n=n.nextA},it.prototype.markSubtree=function(t,i,e){this.A.markSubtree(t,i,e),this.B.markSubtree(t,i,e)},et.prototype.containsObj=function(t){return this.bb_l<=t.bb_l&&this.bb_r>=t.bb_r&&this.bb_b<=t.bb_b&&this.bb_t>=t.bb_t},et.prototype.update=function(t){var i=t.root,e=this.obj;return!this.containsObj(e)&&(t.getBB(this.obj,this),i=pt(i,this,t),t.root=at(i,this,t),this.clearPairs(t),this.stamp=t.getStamp(),!0)},et.prototype.addPairs=function(t){var i=t.dynamicIndex;if(i){var e=i.root;e&&e.markLeafQuery(this,!0,i,null)}else{var s=t.staticIndex.root;this.markSubtree(t,s,null)}},tt.prototype.insert=function(t,i){var e=new et(this,t);this.leaves[i]=e,this.root=at(this.root,e,this),this.count++,e.stamp=this.getStamp(),e.addPairs(this),this.incrementStamp()},tt.prototype.remove=function(t,i){var e=this.leaves[i];delete this.leaves[i],this.root=pt(this.root,e,this),this.count--,e.clearPairs(this),e.recycle(this)},tt.prototype.contains=function(t,i){return null!=this.leaves[i]};var lt=function(t,i){};tt.prototype.reindexQuery=function(t){if(this.root){var i,e=this.leaves;for(i in e)e[i].update(this);var s=this.staticIndex,n=s&&s.root;this.root.markSubtree(this,n,t),s&&!n&&this.collideStatic(this,s,t),this.incrementStamp()}},tt.prototype.reindex=function(){this.reindexQuery(lt)},tt.prototype.reindexObject=function(t,i){var e=this.leaves[i];e&&(e.update(this)&&e.addPairs(this),this.incrementStamp())},tt.prototype.pointQuery=function(t,i){this.query(new O(t.x,t.y,t.x,t.y),i)},tt.prototype.segmentQuery=function(t,i,s,n){this&&this.root&&function r(t,i,s,n,o){if(t.isLeaf)return o(t.obj);var h=ct(t.A,i,s),a=ct(t.B,i,s);return h<a?(h<n&&(n=e(n,r(t.A,i,s,n,o))),a<n&&(n=e(n,r(t.B,i,s,n,o)))):(a<n&&(n=e(n,r(t.B,i,s,n,o))),h<n&&(n=e(n,r(t.A,i,s,n,o)))),n}(this.root,t,i,s,n)},tt.prototype.query=function(t,i){this.root&&function e(t,i,s){t.intersectsBB(i)&&(t.isLeaf?s(t.obj):(e(t.A,i,s),e(t.B,i,s)))}(this.root,t,i)},tt.prototype.count=function(){return this.count},tt.prototype.each=function(t){var i;for(i in this.leaves)t(this.leaves[i].obj)};var yt=function(t,i,s,r,o){return(n(t.bb_r,r)-e(t.bb_l,i))*(n(t.bb_t,o)-e(t.bb_b,s))};tt.prototype.optimize=function(){var t=new Array(this.count),i=0;for(var s in this.leaves)t[i++]=this.nodes[s];tree.subtreeRecycle(root),this.root=function r(t,i,s,o){if(1==o)return i[s];if(2==o)return t.makeNode(i[s],i[s+1]);for(var h=(B=i[s]).bb_l,a=B.bb_b,c=B.bb_r,p=B.bb_t,u=s+o,l=s+1;l<u;l++)B=i[l],h=e(h,B.bb_l),a=e(a,B.bb_b),c=n(c,B.bb_r),p=n(p,B.bb_t);var y=c-h>p-a,f=new Array(2*o);if(y)for(l=s;l<u;l++)f[2*l+0]=i[l].bb_l,f[2*l+1]=i[l].bb_r;else for(l=s;l<u;l++)f[2*l+0]=i[l].bb_b,f[2*l+1]=i[l].bb_t;f.sort(function(t,i){return t-i});var b=.5*(f[o-1]+f[o]),v=h,d=a,_=c,x=p,g=h,m=a,w=c,S=p;y?_=g=b:x=m=b;for(var A=u,j=s;j<A;){var B=i[j];yt(B,g,m,w,S)<yt(B,v,d,_,x)?(A--,i[j]=i[A],i[A]=B):j++}if(A==o){for(B=null,l=s;l<u;l++)B=at(B,i[l],t);return B}return NodeNew(t,r(t,i,s,A-s),r(t,i,A,u-A))}(tree,t,t.length)};tt.prototype.log=function(){this.root&&function t(i,e){!i.isLeaf&&e<=10&&(t(i.A,e+1),t(i.B,e+1));for(var s="",n=0;n<e;n++)s+=" ";console.log(s+i.bb_b+" "+i.bb_t)}(this.root,0)};var ft=t.CollisionHandler=function(){this.a=this.b=0};ft.prototype.begin=function(t,i){return!0},ft.prototype.preSolve=function(t,i){return!0},ft.prototype.postSolve=function(t,i){},ft.prototype.separate=function(t,i){};var bt=function(t,i){this.e=0,this.u=0,this.surface_vr=y,this.a=t,this.body_a=t.body,this.b=i,this.body_b=i.body,this.thread_a_next=this.thread_a_prev=null,this.thread_b_next=this.thread_b_prev=null,this.contacts=null,this.stamp=0,this.handler=null,this.swappedColl=!1,this.state="first coll"};bt.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},bt.prototype.totalImpulse=function(){for(var t=this.contacts,i=new l(0,0),e=0,s=t.length;e<s;e++){var n=t[e];i.add(m(n.n,n.jnAcc))}return this.swappedColl?i:i.neg()},bt.prototype.totalImpulseWithFriction=function(){for(var t=this.contacts,i=new l(0,0),e=0,s=t.length;e<s;e++){var n=t[e];i.add(new l(n.jnAcc,n.jtAcc).rotate(n.n))}return this.swappedColl?i:i.neg()},bt.prototype.totalKE=function(){for(var t=(1-this.e)/(1+this.e),i=0,e=this.contacts,s=0,n=e.length;s<n;s++){var r=e[s],o=r.jnAcc,h=r.jtAcc;i+=t*o*o/r.nMass+h*h/r.tMass}return i},bt.prototype.ignore=function(){this.state="ignore"},bt.prototype.getA=function(){return this.swappedColl?this.b:this.a},bt.prototype.getB=function(){return this.swappedColl?this.a:this.b},bt.prototype.isFirstContact=function(){return"first coll"===this.state};var vt=function(t,i,e){this.point=t,this.normal=i,this.dist=e};bt.prototype.getContactPointSet=function(){var t,i=new Array(this.contacts.length);for(t=0;t<i.length;t++)i[t]=new vt(this.contacts[t].p,this.contacts[t].n,this.contacts[t].dist);return i},bt.prototype.getNormal=function(t){var i=this.contacts[t].n;return this.swappedColl?g(i):i},bt.prototype.getPoint=function(t){return this.contacts[t].p},bt.prototype.getDepth=function(t){return this.contacts[t].dist};var dt=function(t,i,e,s){e?e.body_a===i?e.thread_a_next=s:e.thread_b_next=s:i.arbiterList===t&&(i.arbiterList=s),s&&(s.body_a===i?s.thread_a_prev=e:s.thread_b_prev=e)};bt.prototype.unthread=function(){dt(this,this.body_a,this.thread_a_prev,this.thread_a_next),dt(this,this.body_b,this.thread_b_prev,this.thread_b_next),this.thread_a_prev=this.thread_a_next=null,this.thread_b_prev=this.thread_b_next=null},bt.prototype.update=function(t,i,e,s){if(this.contacts)for(var n=0;n<this.contacts.length;n++)for(var r=this.contacts[n],o=0;o<t.length;o++){var h=t[o];h.hash===r.hash&&(h.jnAcc=r.jnAcc,h.jtAcc=r.jtAcc)}this.contacts=t,this.handler=i,this.swappedColl=e.collision_type!==i.a,this.e=e.e*s.e,this.u=e.u*s.u,this.surface_vr=x(e.surface_v,s.surface_v),this.a=e,this.body_a=e.body,this.b=s,this.body_b=s.body,"cached"==this.state&&(this.state="first coll")},bt.prototype.preStep=function(t,i,s){for(var n=this.body_a,r=this.body_b,o=0;o<this.contacts.length;o++){var h=this.contacts[o];h.r1=x(h.p,n.p),h.r2=x(h.p,r.p),h.nMass=1/Qt(n,r,h.r1,h.r2,h.n),h.tMass=1/Qt(n,r,h.r1,h.r2,A(h.n)),h.bias=-s*e(0,h.dist+i)/t,h.jBias=0,h.bounce=Rt(n,r,h.r1,h.r2,h.n)*this.e}},bt.prototype.applyCachedImpulse=function(t){if(!this.isFirstContact())for(var i=this.body_a,e=this.body_b,s=0;s<this.contacts.length;s++){var n=this.contacts[s],r=n.n.x,o=n.n.y,h=r*n.jnAcc-o*n.jtAcc,a=r*n.jtAcc+o*n.jnAcc;Ot(i,e,n.r1,n.r2,h*t,a*t)}};bt.prototype.applyImpulse=function(){0;for(var t=this.body_a,i=this.body_b,e=this.surface_vr,s=this.u,r=0;r<this.contacts.length;r++){0;var o=this.contacts[r],h=o.nMass,a=o.n,c=o.r1,u=o.r2,l=i.vx-u.y*i.w-(t.vx-c.y*t.w),y=i.vy+u.x*i.w-(t.vy+c.x*t.w),f=a.x*(i.v_biasx-u.y*i.w_bias-t.v_biasx+c.y*t.w_bias)+a.y*(u.x*i.w_bias+i.v_biasy-c.x*t.w_bias-t.v_biasy),v=b(l,y,a.x,a.y),d=b(l+e.x,y+e.y,-a.y,a.x),_=(o.bias-f)*h,x=o.jBias;o.jBias=n(x+_,0);var g=-(o.bounce+v)*h,m=o.jnAcc;o.jnAcc=n(m+g,0);var w=s*o.jnAcc,S=-d*o.tMass,A=o.jtAcc;o.jtAcc=p(A+S,-w,w);var j=a.x*(o.jBias-x),B=a.y*(o.jBias-x);Nt(t,-j,-B,c),Nt(i,j,B,u);var I=o.jnAcc-m,M=o.jtAcc-A;Ot(t,i,c,u,a.x*I-a.y*M,a.x*M+a.y*I)}},bt.prototype.callSeparate=function(t){t.lookupHandler(this.a.collision_type,this.b.collision_type).separate(this,t)},bt.prototype.next=function(t){return this.body_a==t?this.thread_a_next:this.thread_b_next};var _t=function(t,i,e,s){this.p=t,this.n=i,this.dist=e,this.r1=this.r2=y,this.nMass=this.tMass=this.bounce=this.bias=0,this.jnAcc=this.jtAcc=this.jBias=0,this.hash=s,0},xt=[],gt=function(t,i,e,s){var n=e+s,r=x(i,t),o=M(r);if(!(o>=n*n)){var h=Math.sqrt(o);return new _t(_(t,m(r,.5+(e-.5*n)/(h||Infinity))),h?m(r,1/h):new l(1,0),h-n,0)}},mt=0,wt=function(t,i){var e=0,s=t.valueOnAxis(i[0].n,i[0].d);if(s>0)return-1;for(var n=1;n<i.length;n++){var r=t.valueOnAxis(i[n].n,i[n].d);if(r>0)return-1;r>s&&(s=r,e=n)}return mt=s,e},St=function(t,i,e,s){for(var n=[],o=t.tVerts,h=0;h<o.length;h+=2){var a=o[h],c=o[h+1];i.containsVert(a,c)&&n.push(new _t(new l(a,c),e,s,r(t.hashid,h>>1)))}var p=i.tVerts;for(h=0;h<p.length;h+=2){a=p[h],c=p[h+1];t.containsVert(a,c)&&n.push(new _t(new l(a,c),e,s,r(i.hashid,h>>1)))}return n.length?n:function(t,i,e,s){for(var n=[],o=t.tVerts,h=0;h<o.length;h+=2){var a=o[h],c=o[h+1];i.containsVertPartial(a,c,g(e))&&n.push(new _t(new l(a,c),e,s,r(t.hashid,h)))}var p=i.tVerts;for(h=0;h<p.length;h+=2){a=p[h],c=p[h+1];t.containsVertPartial(a,c,e)&&n.push(new _t(new l(a,c),e,s,r(i.hashid,h)))}return n}(t,i,e,s)},At=function(t,i,s){var n=f(i,t.ta)-t.r,r=f(i,t.tb)-t.r;return e(n,r)-s},jt=function(t,i,e,s,n){for(var o=w(i.tn,i.ta),h=w(i.tn,i.tb),a=m(i.tn,n),c=e.tVerts,p=0;p<c.length;p+=2){var u=c[p],y=c[p+1];if(b(u,y,a.x,a.y)<f(i.tn,i.ta)*n+i.r){var v=S(i.tn.x,i.tn.y,u,y);o>=v&&v>=h&&t.push(new _t(new l(u,y),a,s,r(e.hashid,p)))}}};D.prototype.collisionCode=0,z.prototype.collisionCode=1,W.prototype.collisionCode=2,D.prototype.collisionTable=[function(t,i){var e=gt(t.tc,i.tc,t.r,i.r);return e?[e]:xt},function(t,i){var e=i.ta,s=i.tb,n=t.tc,r=x(s,e),o=u(f(r,x(n,e))/M(r)),h=_(e,m(r,o)),a=gt(n,h,t.r,i.r);if(a){var c=a.n;return 0===o&&f(c,i.a_tangent)<0||1===o&&f(c,i.b_tangent)<0?xt:[a]}return xt},function(t,i){for(var e=i.tPlanes,s=0,n=f(e[0].n,t.tc)-e[0].d-t.r,r=0;r<e.length;r++){var o=f(e[r].n,t.tc)-e[r].d-t.r;if(o>0)return xt;o>n&&(n=o,s=r)}var h,a=e[s].n,c=i.tVerts,p=c.length,u=s<<1,y=c[u],b=c[u+1],v=c[(u+2)%p],d=c[(u+3)%p],_=S(a.x,a.y,y,b),A=S(a.x,a.y,v,d),j=w(a,t.tc);return j<A?(h=gt(t.tc,new l(v,d),t.r,0))?[h]:xt:j<_?[new _t(x(t.tc,m(a,t.r+n/2)),g(a),n,0)]:(h=gt(t.tc,new l(y,b),t.r,0))?[h]:xt}],z.prototype.collisionTable=[null,function(t,i){return xt},function(t,i){var e=[],s=i.tPlanes,n=s.length,o=f(t.tn,t.ta),h=i.valueOnAxis(t.tn,o)-t.r,a=i.valueOnAxis(g(t.tn),-o)-t.r;if(a>0||h>0)return xt;var c=0,p=At(t,s[0].n,s[0].d);if(p>0)return xt;for(var u=0;u<n;u++){var y=At(t,s[u].n,s[u].d);if(y>0)return xt;y>p&&(p=y,c=u)}var b=g(s[c].n),v=_(t.ta,m(b,t.r)),d=_(t.tb,m(b,t.r));if(i.containsVert(v.x,v.y)&&e.push(new _t(v,b,p,r(t.hashid,0))),i.containsVert(d.x,d.y)&&e.push(new _t(d,b,p,r(t.hashid,1))),(h>=p||a>=p)&&(h>a?jt(e,t,i,h,1):jt(e,t,i,a,-1)),0===e.length){var x,w=2*c,S=i.tVerts,A=new l(S[w],S[w+1]);if(x=gt(t.ta,A,t.r,0))return[x];if(x=gt(t.tb,A,t.r,0))return[x];var j=2*n,B=new l(S[(w+2)%j],S[(w+3)%j]);if(x=gt(t.ta,B,t.r,0))return[x];if(x=gt(t.tb,B,t.r,0))return[x]}return e}],W.prototype.collisionTable=[null,null,function(t,i){var e=wt(i,t.tPlanes);if(-1==e)return xt;var s=mt,n=wt(t,i.tPlanes);if(-1==n)return xt;var r=mt;return s>r?St(t,i,t.tPlanes[e].n,s):St(t,i,g(i.tPlanes[n].n),r)}];var Bt=t.collideShapes=function(t,i){return t.collisionCode,i.collisionCode,t.collisionTable[i.collisionCode](t,i)},It=new ft,Mt=t.Space=function(){this.stamp=0,this.curr_dt=0,this.bodies=[],this.rousedBodies=[],this.sleepingComponents=[],this.staticShapes=new tt(null),this.activeShapes=new tt(this.staticShapes),this.arbiters=[],this.contactBuffersHead=null,this.cachedArbiters={},this.constraints=[],this.locked=0,this.collisionHandlers={},this.defaultHandler=It,this.postStepCallbacks=[],this.iterations=10,this.gravity=y,this.damping=1,this.idleSpeedThreshold=0,this.sleepTimeThreshold=Infinity,this.collisionSlop=.1,this.collisionBias=Math.pow(.9,60),this.collisionPersistence=3,this.enableContactGraph=!1,this.staticBody=new Y(Infinity,Infinity),this.staticBody.nodeIdleTime=Infinity,this.collideShapes=this.makeCollideShapes()};Mt.prototype.getCurrentTimeStep=function(){return this.curr_dt},Mt.prototype.setIterations=function(t){this.iterations=t},Mt.prototype.isLocked=function(){return this.locked};var Ct=function(t){t.locked};Mt.prototype.addCollisionHandler=function(t,i,e,s,n,o){Ct(this),this.removeCollisionHandler(t,i);var h=new ft;h.a=t,h.b=i,e&&(h.begin=e),s&&(h.preSolve=s),n&&(h.postSolve=n),o&&(h.separate=o),this.collisionHandlers[r(t,i)]=h},Mt.prototype.removeCollisionHandler=function(t,i){Ct(this),delete this.collisionHandlers[r(t,i)]},Mt.prototype.setDefaultCollisionHandler=function(t,i,e,s){Ct(this);var n=new ft;t&&(n.begin=t),i&&(n.preSolve=i),e&&(n.postSolve=e),s&&(n.separate=s),this.defaultHandler=n},Mt.prototype.lookupHandler=function(t,i){return this.collisionHandlers[r(t,i)]||this.defaultHandler},Mt.prototype.addShape=function(t){var i=t.body;return i.isStatic()?this.addStaticShape(t):(t.space,Ct(this),i.activate(),i.addShape(t),t.update(i.p,i.rot),this.activeShapes.insert(t,t.hashid),t.space=this,t)},Mt.prototype.addStaticShape=function(t){t.space,Ct(this);var i=t.body;return i.addShape(t),t.update(i.p,i.rot),this.staticShapes.insert(t,t.hashid),t.space=this,t},Mt.prototype.addBody=function(t){return t.isStatic(),t.space,Ct(this),this.bodies.push(t),t.space=this,t},Mt.prototype.addConstraint=function(t){t.space,Ct(this);var i=t.a,e=t.b;return i.activate(),e.activate(),this.constraints.push(t),t.next_a=i.constraintList,i.constraintList=t,t.next_b=e.constraintList,e.constraintList=t,t.space=this,t},Mt.prototype.filterArbiters=function(t,i){for(var e in this.cachedArbiters){var s=this.cachedArbiters[e];(t!==s.body_a||i!==s.a&&null!==i)&&(t!==s.body_b||i!==s.b&&null!==i)||(i&&"cached"!==s.state&&s.callSeparate(this),s.unthread(),o(this.arbiters,s),delete this.cachedArbiters[e])}},Mt.prototype.removeShape=function(t){var i=t.body;i.isStatic()?this.removeStaticShape(t):(this.containsShape(t),Ct(this),i.activate(),i.removeShape(t),this.filterArbiters(i,t),this.activeShapes.remove(t,t.hashid),t.space=null)},Mt.prototype.removeStaticShape=function(t){this.containsShape(t),Ct(this);var i=t.body;i.isStatic()&&i.activateStatic(t),i.removeShape(t),this.filterArbiters(i,t),this.staticShapes.remove(t,t.hashid),t.space=null},Mt.prototype.removeBody=function(t){this.containsBody(t),Ct(this),t.activate(),o(this.bodies,t),t.space=null},Mt.prototype.removeConstraint=function(t){this.containsConstraint(t),Ct(this),t.a.activate(),t.b.activate(),o(this.constraints,t),t.a.removeConstraint(t),t.b.removeConstraint(t),t.space=null},Mt.prototype.containsShape=function(t){return t.space===this},Mt.prototype.containsBody=function(t){return t.space==this},Mt.prototype.containsConstraint=function(t){return t.space==this},Mt.prototype.uncacheArbiter=function(t){delete this.cachedArbiters[r(t.a.hashid,t.b.hashid)],o(this.arbiters,t)},Mt.prototype.eachBody=function(t){this.lock();for(var i=this.bodies,e=0;e<i.length;e++)t(i[e]);var s=this.sleepingComponents;for(e=0;e<s.length;e++)for(var n=s[e];n;){var r=n.nodeNext;t(n),n=r}this.unlock(!0)},Mt.prototype.eachShape=function(t){this.lock(),this.activeShapes.each(t),this.staticShapes.each(t),this.unlock(!0)},Mt.prototype.eachConstraint=function(t){this.lock();for(var i=this.constraints,e=0;e<i.length;e++)t(i[e]);this.unlock(!0)},Mt.prototype.reindexStatic=function(){this.locked,this.staticShapes.each(function(t){var i=t.body;t.update(i.p,i.rot)}),this.staticShapes.reindex()},Mt.prototype.reindexShape=function(t){this.locked;var i=t.body;t.update(i.p,i.rot),this.activeShapes.reindexObject(t,t.hashid),this.staticShapes.reindexObject(t,t.hashid)},Mt.prototype.reindexShapesForBody=function(t){for(var i=t.shapeList;i;i=i.next)this.reindexShape(i)},Mt.prototype.useSpatialHash=function(t,i){throw new Error("Spatial Hash not implemented.")},Mt.prototype.activateBody=function(t){if(t.isRogue(),this.locked)-1===this.rousedBodies.indexOf(t)&&this.rousedBodies.push(t);else{this.bodies.push(t);for(var i=0;i<t.shapeList.length;i++){var e=t.shapeList[i];this.staticShapes.remove(e,e.hashid),this.activeShapes.insert(e,e.hashid)}for(var s=t.arbiterList;s;s=s.next(t)){if(t===(a=s.body_a)||a.isStatic()){var n=s.a,o=s.b;this.cachedArbiters[r(n.hashid,o.hashid)]=s,s.stamp=this.stamp,s.handler=this.lookupHandler(n.collision_type,o.collision_type),this.arbiters.push(s)}}for(var h=t.constraintList;h;h=h.nodeNext){var a;(t===(a=h.a)||a.isStatic())&&this.constraints.push(h)}}},Mt.prototype.deactivateBody=function(t){t.isRogue(),o(this.bodies,t);for(var i=0;i<t.shapeList.length;i++){var e=t.shapeList[i];this.activeShapes.remove(e,e.hashid),this.staticShapes.insert(e,e.hashid)}for(var s=t.arbiterList;s;s=s.next(t)){(t===(r=s.body_a)||r.isStatic())&&this.uncacheArbiter(s)}for(var n=t.constraintList;n;n=n.nodeNext){var r;(t===(r=n.a)||r.isStatic())&&o(this.constraints,n)}};var kt=function(t){return t?t.nodeRoot:null};Y.prototype.activate=function(){this.isRogue()||(this.nodeIdleTime=0,function(t){if(t&&t.isSleeping(t)){t.isRogue();for(var i=t.space,e=t;e;){var s=e.nodeNext;e.nodeIdleTime=0,e.nodeRoot=null,e.nodeNext=null,i.activateBody(e),e=s}o(i.sleepingComponents,t)}}(kt(this)))},Y.prototype.activateStatic=function(t){this.isStatic();for(var i=this.arbiterList;i;i=i.next(this))t&&t!=i.a&&t!=i.b||(i.body_a==this?i.body_b:i.body_a).activate()},Y.prototype.pushArbiter=function(t){t.body_a===this?t.thread_a_next:t.thread_b_next,t.body_a===this?t.thread_a_prev:t.thread_b_prev;var i=this.arbiterList;null===i||(i.body_a===this?i.thread_a_prev:i.thread_b_prev),t.body_a===this?t.thread_a_next=i:t.thread_b_next=i,i&&(i.body_a===this?i.thread_a_prev=t:i.thread_b_prev=t),this.arbiterList=t};var Pt=function ni(t,i){if(!i.isRogue()){var e=kt(i);if(null==e){!function(t,i){i.nodeRoot=t,i!==t&&(i.nodeNext=t.nodeNext,t.nodeNext=i)}(t,i);for(var s=i.arbiterList;s;s=s.next(i))ni(t,i==s.body_a?s.body_b:s.body_a);for(var n=i.constraintList;n;n=n.next(i))ni(t,i==n.a?n.b:n.a)}}},Lt=function(t,i){for(var e=t;e;e=e.nodeNext)if(e.nodeIdleTime<i)return!0;return!1};Mt.prototype.processComponents=function(t){for(var i=this.sleepTimeThreshold!==Infinity,e=this.bodies,s=0;s<e.length;s++){(o=e[s]).nodeNext,o.nodeRoot}if(i){var n=this.idleSpeedThreshold,r=n?n*n:M(this.gravity)*t*t;for(s=0;s<e.length;s++){var o=e[s],h=r?o.m*r:0;o.nodeIdleTime=o.kineticEnergy()>h?0:o.nodeIdleTime+t}}for(var a=this.arbiters,c=(s=0,a.length);s<c;s++){var p=a[s],u=p.body_a,l=p.body_b;i&&((l.isRogue()&&!l.isStatic()||u.isSleeping())&&u.activate(),(u.isRogue()&&!u.isStatic()||l.isSleeping())&&l.activate()),u.pushArbiter(p),l.pushArbiter(p)}if(i){var y=this.constraints;for(s=0;s<y.length;s++){var f=y[s];u=f.a;(l=f.b).isRogue()&&!l.isStatic()&&u.activate(),u.isRogue()&&!u.isStatic()&&l.activate()}for(s=0;s<e.length;){o=e[s];if(null!==kt(o)||(Pt(o,o),Lt(o,this.sleepTimeThreshold)))s++,o.nodeRoot=null,o.nodeNext=null;else{this.sleepingComponents.push(o);for(var b=o;b;b=b.nodeNext)this.deactivateBody(b)}}}},Y.prototype.sleep=function(){this.sleepWithGroup(null)},Y.prototype.sleepWithGroup=function(t){!this.isStatic()&&this.isRogue();var i=this.space;if(i.locked,null===t||t.isSleeping(),this.isSleeping())return kt(this),void kt(t);for(var e=0;e<this.shapeList.length;e++)this.shapeList[e].update(this.p,this.rot);if(i.deactivateBody(this),t){var s=kt(t);this.nodeRoot=s,this.nodeNext=s.nodeNext,this.nodeIdleTime=0,s.nodeNext=this}else this.nodeRoot=this,this.nodeNext=null,this.nodeIdleTime=0,i.sleepingComponents.push(this);o(i.bodies,this)},Mt.prototype.activateShapesTouchingShape=function(t){this.sleepTimeThreshold!==Infinity&&this.shapeQuery(t,function(t,i){t.body.activate()})},Mt.prototype.pointQuery=function(t,i,e,s){var n=function(n){(!n.group||e!==n.group)&&i&n.layers&&n.pointQuery(t)&&s(n)},r=new O(t.x,t.y,t.x,t.y);this.lock(),this.activeShapes.query(r,n),this.staticShapes.query(r,n),this.unlock(!0)},Mt.prototype.pointQueryFirst=function(t,i,e){var s=null;return this.pointQuery(t,i,e,function(t){t.sensor||(s=t)}),s},Mt.prototype.nearestPointQuery=function(t,i,e,s,n){var r=function(r){if((!r.group||s!==r.group)&&e&r.layers){var o=r.nearestPointQuery(t);o.d<i&&n(r,o.d,o.p)}},o=N(t,i);this.lock(),this.activeShapes.query(o,r),this.staticShapes.query(o,r),this.unlock(!0)},Mt.prototype.nearestPointQueryNearest=function(t,i,e,s){var n,r=function(r){if((!r.group||s!==r.group)&&e&r.layers&&!r.sensor){var o=r.nearestPointQuery(t);o.d<i&&(!n||o.d<n.d)&&(n=o)}},o=N(t,i);return this.activeShapes.query(o,r),this.staticShapes.query(o,r),n},Mt.prototype.segmentQuery=function(t,i,e,s,n){var r=function(r){var o;return(!r.group||s!==r.group)&&e&r.layers&&(o=r.segmentQuery(t,i))&&n(r,o.t,o.n),1};this.lock(),this.staticShapes.segmentQuery(t,i,1,r),this.activeShapes.segmentQuery(t,i,1,r),this.unlock(!0)},Mt.prototype.segmentQueryFirst=function(t,i,e,s){var n=null,r=function(r){var o;return(!r.group||s!==r.group)&&e&r.layers&&!r.sensor&&(o=r.segmentQuery(t,i))&&(null===n||o.t<n.t)&&(n=o),n?n.t:1};return this.staticShapes.segmentQuery(t,i,1,r),this.activeShapes.segmentQuery(t,i,n?n.t:1,r),n},Mt.prototype.bbQuery=function(t,i,e,s){var n=function(n){(!n.group||e!==n.group)&&i&n.layers&&function(t,i,e,s,n){return t.l<=s&&i<=t.r&&t.b<=n&&e<=t.t}(t,n.bb_l,n.bb_b,n.bb_r,n.bb_t)&&s(n)};this.lock(),this.activeShapes.query(t,n),this.staticShapes.query(t,n),this.unlock(!0)},Mt.prototype.shapeQuery=function(t,i){var e=t.body;e&&t.update(e.p,e.rot);var s=new O(t.bb_l,t.bb_b,t.bb_r,t.bb_t),n=!1,r=function(e){var s=t;if((!s.group||s.group!==e.group)&&s.layers&e.layers&&s!==e){var r;if(s.collisionCode<=e.collisionCode)r=Bt(s,e);else{r=Bt(e,s);for(var o=0;o<r.length;o++)r[o].n=g(r[o].n)}if(r.length&&(n=!(s.sensor||e.sensor),i)){var h=new Array(r.length);for(o=0;o<r.length;o++)h[o]=new vt(r[o].p,r[o].n,r[o].dist);i(e,h)}}};return this.lock(),this.activeShapes.query(s,r),this.staticShapes.query(s,r),this.unlock(!0),n},Mt.prototype.addPostStepCallback=function(t){this.locked,this.postStepCallbacks.push(t)},Mt.prototype.runPostStepCallbacks=function(){for(var t=0;t<this.postStepCallbacks.length;t++)this.postStepCallbacks[t]();this.postStepCallbacks=[]},Mt.prototype.lock=function(){this.locked++},Mt.prototype.unlock=function(t){if(this.locked--,this.locked,0===this.locked&&t){for(var i=this.rousedBodies,e=0;e<i.length;e++)this.activateBody(i[e]);i.length=0,this.runPostStepCallbacks()}},Mt.prototype.makeCollideShapes=function(){var t=this;return function(i,e){var s=t;if(
//!bbIntersects(a.bb, b.bb)
i.bb_l<=e.bb_r&&e.bb_l<=i.bb_r&&i.bb_b<=e.bb_t&&e.bb_b<=i.bb_t&&i.body!==e.body&&(!i.group||i.group!==e.group)&&i.layers&e.layers){var n=s.lookupHandler(i.collision_type,e.collision_type),o=i.sensor||e.sensor;if(!o||n!==It){if(i.collisionCode>e.collisionCode){var h=i;i=e,e=h}var a=Bt(i,e);if(0!==a.length){var c=r(i.hashid,e.hashid),p=s.cachedArbiters[c];p||(p=s.cachedArbiters[c]=new bt(i,e)),p.update(a,n,i,e),"first coll"!=p.state||n.begin(p,s)||p.ignore(),"ignore"!==p.state&&n.preSolve(p,s)&&!o?s.arbiters.push(p):(p.contacts=null,"ignore"!==p.state&&(p.state="normal")),p.stamp=s.stamp}}}}},Mt.prototype.arbiterSetFilter=function(t){var i=this.stamp-t.stamp,e=t.body_a,s=t.body_b;return!(!e.isStatic()&&!e.isSleeping()||!s.isStatic()&&!s.isSleeping())||(i>=1&&"cached"!=t.state&&(t.callSeparate(this),t.state="cached"),!(i>=this.collisionPersistence)||(t.contacts=null,!1))};var $t=function(t){var i=t.body;t.update(i.p,i.rot)};Mt.prototype.step=function(t){if(0!==t){0===y.x&&y.y,this.stamp++;var i,e,s,n=this.curr_dt;this.curr_dt=t;var r=this.bodies,o=this.constraints,h=this.arbiters;for(i=0;i<h.length;i++){var a=h[i];a.state="normal",a.body_a.isSleeping()||a.body_b.isSleeping()||a.unthread()}for(h.length=0,this.lock(),i=0;i<r.length;i++)r[i].position_func(t);for(s in this.activeShapes.each($t),this.activeShapes.reindexQuery(this.collideShapes),this.unlock(!1),this.processComponents(t),this.lock(),this.cachedArbiters)this.arbiterSetFilter(this.cachedArbiters[s])||delete this.cachedArbiters[s];var c=this.collisionSlop,p=1-Math.pow(this.collisionBias,t);for(i=0;i<h.length;i++)h[i].preStep(t,c,p);for(i=0;i<o.length;i++){var u=o[i];u.preSolve(this),u.preStep(t)}var l=Math.pow(this.damping,t),f=this.gravity;for(i=0;i<r.length;i++)r[i].velocity_func(f,l,t);var b=0===n?0:t/n;for(i=0;i<h.length;i++)h[i].applyCachedImpulse(b);for(i=0;i<o.length;i++)o[i].applyCachedImpulse(b);for(i=0;i<this.iterations;i++){for(e=0;e<h.length;e++)h[e].applyImpulse();for(e=0;e<o.length;e++)o[e].applyImpulse()}for(i=0;i<o.length;i++)o[i].postSolve(this);for(i=0;i<h.length;i++)h[i].handler.postSolve(h[i],this);this.unlock(!0)}};var Ft=function(t,i,e,s){var n=t.vx+-e.y*t.w,r=t.vy+e.x*t.w,o=i.vx+-s.y*i.w,h=i.vy+s.x*i.w;return new l(o-n,h-r)},Rt=function(t,i,e,s,n){var r=t.vx+-e.y*t.w,o=t.vy+e.x*t.w,h=i.vx+-s.y*i.w,a=i.vy+s.x*i.w;return b(h-r,a-o,n.x,n.y)},Vt=function(t,i,e,s){t.vx+=i*t.m_inv,t.vy+=e*t.m_inv,t.w+=t.i_inv*(s.x*e-s.y*i)},Ot=function(t,i,e,s,n,r){Vt(t,-n,-r,e),Vt(i,n,r,s)},Nt=function(t,i,e,s){t.v_biasx+=i*t.m_inv,t.v_biasy+=e*t.m_inv,t.w_bias+=t.i_inv*S(s.x,s.y,i,e)},Tt=function(t,i,e){var s=w(i,e);return t.m_inv+t.i_inv*s*s},Qt=function(t,i,e,s,n){var r=Tt(t,e,n)+Tt(i,s,n);return r},qt=function(t,i,e,s,n,r){var o,h,a,c,p=t.m_inv+i.m_inv;o=p,h=0,a=0,c=p;var u=t.i_inv,l=e.x*e.x*u,y=e.y*e.y*u,f=-e.x*e.y*u;o+=y,h+=f,a+=f,c+=l;var b=i.i_inv,v=s.x*s.x*b,d=s.y*s.y*b,_=-s.x*s.y*b,x=(o+=d)*(c+=v)-(h+=_)*(a+=_),g=1/x;n.x=c*g,n.y=-h*g,r.x=-a*g,r.y=o*g},Ht=function(t,i,e){return new l(f(t,i),f(t,e))},Et=function(t,i){return 1-Math.pow(t,i)},Dt=t.Constraint=function(t,i){this.a=t,this.b=i,this.space=null,this.next_a=null,this.next_b=null,this.maxForce=Infinity,this.errorBias=Math.pow(.9,60),this.maxBias=Infinity};Dt.prototype.activateBodies=function(){this.a&&this.a.activate(),this.b&&this.b.activate()},Dt.prototype.preStep=function(t){},Dt.prototype.applyCachedImpulse=function(t){},Dt.prototype.applyImpulse=function(){},Dt.prototype.getImpulse=function(){return 0},Dt.prototype.preSolve=function(t){},Dt.prototype.postSolve=function(t){},Dt.prototype.next=function(t){return this.a===t?this.next_a:this.next_b};var Gt=t.PinJoint=function(t,i,e,s){Dt.call(this,t,i),this.anchr1=e,this.anchr2=s;var n=t?_(t.p,B(e,t.rot)):e,r=i?_(i.p,B(s,i.rot)):s;this.dist=v(x(r,n)),this.dist,this.r1=this.r2=null,this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};Gt.prototype=Object.create(Dt.prototype),Gt.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=B(this.anchr1,i.rot),this.r2=B(this.anchr2,e.rot);var s=x(_(e.p,this.r2),_(i.p,this.r1)),n=v(s);this.n=m(s,1/(n||Infinity)),this.nMass=1/Qt(i,e,this.r1,this.r2,this.n);var r=this.maxBias;this.bias=p(-Et(this.errorBias,t)*(n-this.dist)/t,-r,r),this.jnMax=this.maxForce*t},Gt.prototype.applyCachedImpulse=function(t){var i=m(this.n,this.jnAcc*t);Ot(this.a,this.b,this.r1,this.r2,i.x,i.y)},Gt.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.n,s=Rt(t,i,this.r1,this.r2,e),n=(this.bias-s)*this.nMass,r=this.jnAcc;this.jnAcc=p(r+n,-this.jnMax,this.jnMax),n=this.jnAcc-r,Ot(t,i,this.r1,this.r2,e.x*n,e.y*n)},Gt.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var zt=t.SlideJoint=function(t,i,e,s,n,r){Dt.call(this,t,i),this.anchr1=e,this.anchr2=s,this.min=n,this.max=r,this.r1=this.r2=this.n=null,this.nMass=0,this.jnAcc=this.jnMax=0,this.bias=0};zt.prototype=Object.create(Dt.prototype),zt.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=B(this.anchr1,i.rot),this.r2=B(this.anchr2,e.rot);var s=x(_(e.p,this.r2),_(i.p,this.r1)),n=v(s),r=0;n>this.max?(r=n-this.max,this.n=L(s)):n<this.min?(r=this.min-n,this.n=g(L(s))):(this.n=y,this.jnAcc=0),this.nMass=1/Qt(i,e,this.r1,this.r2,this.n);var o=this.maxBias;this.bias=p(-Et(this.errorBias,t)*r/t,-o,o),this.jnMax=this.maxForce*t},zt.prototype.applyCachedImpulse=function(t){var i=this.jnAcc*t;Ot(this.a,this.b,this.r1,this.r2,this.n.x*i,this.n.y*i)},zt.prototype.applyImpulse=function(){if(0!==this.n.x||0!==this.n.y){var t=this.a,i=this.b,e=this.n,s=this.r1,n=this.r2,r=Ft(t,i,s,n),o=f(r,e),h=(this.bias-o)*this.nMass,a=this.jnAcc;this.jnAcc=p(a+h,-this.jnMax,0),h=this.jnAcc-a,Ot(t,i,this.r1,this.r2,e.x*h,e.y*h)}},zt.prototype.getImpulse=function(){return Math.abs(this.jnAcc)};var Jt=t.PivotJoint=function(t,i,e,s){if(Dt.call(this,t,i),void 0===s){var n=e;e=t?t.world2Local(n):n,s=i?i.world2Local(n):n}this.anchr1=e,this.anchr2=s,this.r1=this.r2=y,this.k1=new l(0,0),this.k2=new l(0,0),this.jAcc=y,this.jMaxLen=0,this.bias=y};Jt.prototype=Object.create(Dt.prototype),Jt.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=B(this.anchr1,i.rot),this.r2=B(this.anchr2,e.rot),qt(i,e,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var s=x(_(e.p,this.r2),_(i.p,this.r1));this.bias=$(m(s,-Et(this.errorBias,t)/t),this.maxBias)},Jt.prototype.applyCachedImpulse=function(t){Ot(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},Jt.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.r1,s=this.r2,n=Ft(t,i,e,s),r=Ht(x(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=$(_(this.jAcc,r),this.jMaxLen),Ot(t,i,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},Jt.prototype.getImpulse=function(){return v(this.jAcc)};var Wt=t.GrooveJoint=function(t,i,e,s,n){Dt.call(this,t,i),this.grv_a=e,this.grv_b=s,this.grv_n=A(P(x(s,e))),this.anchr2=n,this.grv_tn=null,this.clamp=0,this.r1=this.r2=null,this.k1=new l(0,0),this.k2=new l(0,0),this.jAcc=y,this.jMaxLen=0,this.bias=null};Wt.prototype=Object.create(Dt.prototype),Wt.prototype.preStep=function(t){var i=this.a,e=this.b,s=i.local2World(this.grv_a),n=i.local2World(this.grv_b),r=B(this.grv_n,i.rot),o=f(s,r);this.grv_tn=r,this.r2=B(this.anchr2,e.rot);var h=w(_(e.p,this.r2),r);h<=w(s,r)?(this.clamp=1,this.r1=x(s,i.p)):h>=w(n,r)?(this.clamp=-1,this.r1=x(n,i.p)):(this.clamp=0,this.r1=x(_(m(A(r),-h),m(r,o)),i.p)),qt(i,e,this.r1,this.r2,this.k1,this.k2),this.jMaxLen=this.maxForce*t;var a=x(_(e.p,this.r2),_(i.p,this.r1));this.bias=$(m(a,-Et(this.errorBias,t)/t),this.maxBias)},Wt.prototype.applyCachedImpulse=function(t){Ot(this.a,this.b,this.r1,this.r2,this.jAcc.x*t,this.jAcc.y*t)},Wt.prototype.grooveConstrain=function(t){var i=this.grv_tn,e=this.clamp*w(t,i)>0?t:j(t,i);return $(e,this.jMaxLen)},Wt.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.r1,s=this.r2,n=Ft(t,i,e,s),r=Ht(x(this.bias,n),this.k1,this.k2),o=this.jAcc;this.jAcc=this.grooveConstrain(_(o,r)),Ot(t,i,this.r1,this.r2,this.jAcc.x-o.x,this.jAcc.y-o.y)},Wt.prototype.getImpulse=function(){return v(this.jAcc)},Wt.prototype.setGrooveA=function(t){this.grv_a=t,this.grv_n=A(P(x(this.grv_b,t))),this.activateBodies()},Wt.prototype.setGrooveB=function(t){this.grv_b=t,this.grv_n=A(P(x(t,this.grv_a))),this.activateBodies()};var Ut=function(t,i){return(t.restLength-i)*t.stiffness},Kt=t.DampedSpring=function(t,i,e,s,n,r,o){Dt.call(this,t,i),this.anchr1=e,this.anchr2=s,this.restLength=n,this.stiffness=r,this.damping=o,this.springForceFunc=Ut,this.target_vrn=this.v_coef=0,this.r1=this.r2=null,this.nMass=0,this.n=null};Kt.prototype=Object.create(Dt.prototype),Kt.prototype.preStep=function(t){var i=this.a,e=this.b;this.r1=B(this.anchr1,i.rot),this.r2=B(this.anchr2,e.rot);var s=x(_(e.p,this.r2),_(i.p,this.r1)),n=v(s);this.n=m(s,1/(n||Infinity));var r=Qt(i,e,this.r1,this.r2,this.n);this.nMass=1/r,this.target_vrn=0,this.v_coef=1-Math.exp(-this.damping*t*r);var o=this.springForceFunc(this,n);Ot(i,e,this.r1,this.r2,this.n.x*o*t,this.n.y*o*t)},Kt.prototype.applyCachedImpulse=function(t){},Kt.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=this.n,s=this.r1,n=this.r2,r=Rt(t,i,s,n,e),o=(this.target_vrn-r)*this.v_coef;this.target_vrn=r+o,o*=this.nMass,Ot(t,i,this.r1,this.r2,this.n.x*o,this.n.y*o)},Kt.prototype.getImpulse=function(){return 0};var Yt=function(t,i){return(i-t.restAngle)*t.stiffness},Xt=t.DampedRotarySpring=function(t,i,e,s,n){Dt.call(this,t,i),this.restAngle=e,this.stiffness=s,this.damping=n,this.springTorqueFunc=Yt,this.target_wrn=0,this.w_coef=0,this.iSum=0};Xt.prototype=Object.create(Dt.prototype),Xt.prototype.preStep=function(t){var i=this.a,e=this.b,s=i.i_inv+e.i_inv;this.iSum=1/s,this.w_coef=1-Math.exp(-this.damping*t*s),this.target_wrn=0;var n=this.springTorqueFunc(this,i.a-e.a)*t;i.w-=n*i.i_inv,e.w+=n*e.i_inv},Xt.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=t.w-i.w,s=(this.target_wrn-e)*this.w_coef;this.target_wrn=e+s;var n=s*this.iSum;t.w+=n*t.i_inv,i.w-=n*i.i_inv};var Zt=t.RotaryLimitJoint=function(t,i,e,s){Dt.call(this,t,i),this.min=e,this.max=s,this.jAcc=0,this.iSum=this.bias=this.jMax=0};Zt.prototype=Object.create(Dt.prototype),Zt.prototype.preStep=function(t){var i=this.a,e=this.b,s=e.a-i.a,n=0;s>this.max?n=this.max-s:s<this.min&&(n=this.min-s),this.iSum=1/(1/i.i+1/e.i);var r=this.maxBias;this.bias=p(-Et(this.errorBias,t)*n/t,-r,r),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},Zt.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv,e.w+=s*e.i_inv},Zt.prototype.applyImpulse=function(){if(this.bias){var t=this.a,i=this.b,e=i.w-t.w,s=-(this.bias+e)*this.iSum,n=this.jAcc;this.bias<0?this.jAcc=p(n+s,0,this.jMax):this.jAcc=p(n+s,-this.jMax,0),s=this.jAcc-n,t.w-=s*t.i_inv,i.w+=s*i.i_inv}},Zt.prototype.getImpulse=function(){return Math.abs(joint.jAcc)};var ti=t.RatchetJoint=function(t,i,e,s){Dt.call(this,t,i),this.angle=0,this.phase=e,this.ratchet=s,this.angle=(i?i.a:0)-(t?t.a:0),this.iSum=this.bias=this.jAcc=this.jMax=0};ti.prototype=Object.create(Dt.prototype),ti.prototype.preStep=function(t){var i=this.a,e=this.b,s=this.angle,n=this.phase,r=this.ratchet,o=e.a-i.a,h=s-o,a=0;h*r>0?a=h:this.angle=Math.floor((o-n)/r)*r+n,this.iSum=1/(i.i_inv+e.i_inv);var c=this.maxBias;this.bias=p(-Et(this.errorBias,t)*a/t,-c,c),this.jMax=this.maxForce*t,this.bias||(this.jAcc=0)},ti.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv,e.w+=s*e.i_inv},ti.prototype.applyImpulse=function(){if(this.bias){var t=this.a,i=this.b,e=i.w-t.w,s=this.ratchet,n=-(this.bias+e)*this.iSum,r=this.jAcc;this.jAcc=p((r+n)*s,0,this.jMax*Math.abs(s))/s,n=this.jAcc-r,t.w-=n*t.i_inv,i.w+=n*i.i_inv}},ti.prototype.getImpulse=function(t){return Math.abs(t.jAcc)};var ii=t.GearJoint=function(t,i,e,s){Dt.call(this,t,i),this.phase=e,this.ratio=s,this.ratio_inv=1/s,this.jAcc=0,this.iSum=this.bias=this.jMax=0};ii.prototype=Object.create(Dt.prototype),ii.prototype.preStep=function(t){var i=this.a,e=this.b;this.iSum=1/(i.i_inv*this.ratio_inv+this.ratio*e.i_inv);var s=this.maxBias;this.bias=p(-Et(this.errorBias,t)*(e.a*this.ratio-i.a-this.phase)/t,-s,s),this.jMax=this.maxForce*t},ii.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv*this.ratio_inv,e.w+=s*e.i_inv},ii.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=i.w*this.ratio-t.w,s=(this.bias-e)*this.iSum,n=this.jAcc;this.jAcc=p(n+s,-this.jMax,this.jMax),s=this.jAcc-n,t.w-=s*t.i_inv*this.ratio_inv,i.w+=s*i.i_inv},ii.prototype.getImpulse=function(){return Math.abs(this.jAcc)},ii.prototype.setRatio=function(t){this.ratio=t,this.ratio_inv=1/t,this.activateBodies()};var ei=t.SimpleMotor=function(t,i,e){Dt.call(this,t,i),this.rate=e,this.jAcc=0,this.iSum=this.jMax=0};ei.prototype=Object.create(Dt.prototype),ei.prototype.preStep=function(t){this.iSum=1/(this.a.i_inv+this.b.i_inv),this.jMax=this.maxForce*t},ei.prototype.applyCachedImpulse=function(t){var i=this.a,e=this.b,s=this.jAcc*t;i.w-=s*i.i_inv,e.w+=s*e.i_inv},ei.prototype.applyImpulse=function(){var t=this.a,i=this.b,e=-(i.w-t.w+this.rate)*this.iSum,s=this.jAcc;this.jAcc=p(s+e,-this.jMax,this.jMax),e=this.jAcc-s,t.w-=e*t.i_inv,i.w+=e*i.i_inv},ei.prototype.getImpulse=function(){return Math.abs(this.jAcc)}}()}}));