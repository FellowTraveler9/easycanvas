!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var a in r)("object"==typeof exports?exports:e)[a]=r[a]}}(this,function(){return function(e){function t(a){if(r[a])return r[a].exports;var n=r[a]={exports:{},id:a,loaded:!1};return e[a].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}({0:function(e,t,r){e.exports=r(88)},23:function(e,t,r){"use strict";function a(e){this.manager=void 0!==e?e:o.DefaultLoadingManager}Object.defineProperty(t,"__esModule",{value:!0}),t.FileLoader=void 0;var n=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},i=r(60),o=r(63),s={};n(a.prototype,{load:function(e,t,r,a){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);var n=this,o=i.Cache.get(e);if(void 0!==o)return n.manager.itemStart(e),setTimeout(function(){t&&t(o),n.manager.itemEnd(e)},0),o;if(void 0!==s[e])return void s[e].push({onLoad:t,onProgress:r,onError:a});var u=/^data:(.*?)(;base64)?,(.*)$/,d=e.match(u);if(d){var l=d[1],A=!!d[2],f=d[3];f=window.decodeURIComponent(f),A&&(f=window.atob(f));try{var h,p=(this.responseType||"").toLowerCase();switch(p){case"arraybuffer":case"blob":for(var c=new Uint8Array(f.length),g=0;g<f.length;g++)c[g]=f.charCodeAt(g);h="blob"===p?new Blob([c.buffer],{type:l}):c.buffer;break;case"document":var m=new DOMParser;h=m.parseFromString(f,l);break;case"json":h=JSON.parse(f);break;default:h=f}window.setTimeout(function(){t&&t(h),n.manager.itemEnd(e)},0)}catch(t){window.setTimeout(function(){a&&a(t),n.manager.itemEnd(e),n.manager.itemError(e)},0)}}else{s[e]=[],s[e].push({onLoad:t,onProgress:r,onError:a});var v=new XMLHttpRequest;v.open("GET",e,!0),v.addEventListener("load",function(t){var r=this.response;i.Cache.add(e,r);var a=s[e];if(delete s[e],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received.");for(var o=0,u=a.length;o<u;o++){var d=a[o];d.onLoad&&d.onLoad(r)}n.manager.itemEnd(e)}else{for(var o=0,u=a.length;o<u;o++){var d=a[o];d.onError&&d.onError(t)}n.manager.itemEnd(e),n.manager.itemError(e)}},!1),v.addEventListener("progress",function(t){for(var r=s[e],a=0,n=r.length;a<n;a++){var i=r[a];i.onProgress&&i.onProgress(t)}},!1),v.addEventListener("error",function(t){var r=s[e];delete s[e];for(var a=0,i=r.length;a<i;a++){var o=r[a];o.onError&&o.onError(t)}n.manager.itemEnd(e),n.manager.itemError(e)},!1),void 0!==this.responseType&&(v.responseType=this.responseType),void 0!==this.withCredentials&&(v.withCredentials=this.withCredentials),v.overrideMimeType&&v.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(var b in this.requestHeader)v.setRequestHeader(b,this.requestHeader[b]);v.send(null)}return n.manager.itemStart(e),v},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),t.FileLoader=a},60:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={enabled:!1,files:{},add:function(e,t){this.enabled!==!1&&(this.files[e]=t)},get:function(e){if(this.enabled!==!1)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};t.Cache=r},61:function(e,t){"use strict";function r(e,t,r,a){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==a?a:new t.constructor(r),this.sampleValues=t,this.valueSize=r}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e};a(r.prototype,{evaluate:function(e){var t=this.parameterPositions,r=this._cachedIndex,a=t[r],n=t[r-1];e:{t:{var i;r:{a:if(!(e<a)){for(var o=r+2;;){if(void 0===a){if(e<n)break a;return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,e,n)}if(r===o)break;if(n=a,a=t[++r],e<a)break t}i=t.length;break r}{if(e>=n)break e;var s=t[1];e<s&&(r=2,n=s);for(var o=r-2;;){if(void 0===n)return this._cachedIndex=0,this.beforeStart_(0,e,a);if(r===o)break;if(a=n,n=t[--r-1],e>=n)break t}i=r,r=0}}for(;r<i;){var u=r+i>>>1;e<t[u]?i=u:r=u+1}if(a=t[r],n=t[r-1],void 0===n)return this._cachedIndex=0,this.beforeStart_(0,e,a);if(void 0===a)return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,n,e)}this._cachedIndex=r,this.intervalChanged_(r,n,a)}return this.interpolate_(r,n,e,a)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,r=this.sampleValues,a=this.valueSize,n=e*a,i=0;i!==a;++i)t[i]=r[n+i];return t},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),a(r.prototype,{beforeStart_:r.prototype.copySampleValue_,afterEnd_:r.prototype.copySampleValue_}),t.Interpolant=r},62:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={decodeText:function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",r=0,a=e.length;r<a;r++)t+=String.fromCharCode(e[r]);return decodeURIComponent(escape(t))},extractUrlBase:function(e){var t=e.lastIndexOf("/");return t===-1?"./":e.substr(0,t+1)}};t.LoaderUtils=r},63:function(e,t){"use strict";function r(e,t,r){var a=this,n=!1,i=0,o=0,s=void 0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){o++,n===!1&&void 0!==a.onStart&&a.onStart(e,i,o),n=!0},this.itemEnd=function(e){i++,void 0!==a.onProgress&&a.onProgress(e,i,o),i===o&&(n=!1,void 0!==a.onLoad&&a.onLoad())},this.itemError=function(e){void 0!==a.onError&&a.onError(e)},this.resolveURL=function(e){return s?s(e):e},this.setURLModifier=function(e){return s=e,this}}Object.defineProperty(t,"__esModule",{value:!0});var a=new r;t.DefaultLoadingManager=a,t.LoadingManager=r},64:function(e,t,r){"use strict";var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},n=r(23),i=r(62),o=r(61),s={FileLoader:n.FileLoader,LoaderUtils:i.LoaderUtils,Interpolant:o.Interpolant};e.exports=function(){function e(e){this.manager=void 0!==e?e:s.DefaultLoadingManager,this.loader=new s.FileLoader(this.manager),this.parser=null,this.meshBuilder=new t(this.manager),this.animationBuilder=new i}function t(e){this.geometryBuilder=new r,this.materialBuilder=new n(e)}function r(){}function n(e){this.manager=e,this.tgaLoader=null}function i(){}function o(e,t,r,a,n){s.Interpolant.call(this,e,t,r,a),this.interpolationParams=n}e.prototype={constructor:e,crossOrigin:void 0,setCrossOrigin:function(e){return this.crossOrigin=e,this},load:function(e,t,r,a){var n=(this._getParser(),this.meshBuilder.setCrossOrigin(this.crossOrigin)),i=s.LoaderUtils.extractUrlBase(e),o=this._extractExtension(e).toLowerCase();return"pmd"!==o&&"pmx"!==o?void(a&&a(new Error("THREE.MMDLoader: Unknown model file extension ."+o+"."))):void this["pmd"===o?"loadPMD":"loadPMX"](e,function(e){t(n.build(e,i,r,a))},r,a)},loadAnimation:function(e,t,r,a,n){var i=this.animationBuilder;this.loadVMD(e,function(e){r(t.isCamera?i.buildCameraAnimation(e):i.build(e,t))},a,n)},loadWithAnimation:function(e,t,r,a,n){var i=this;this.load(e,function(e){i.loadAnimation(t,e,function(t){r({mesh:e,animation:t})},a,n)},a,n)},loadPMD:function(e,t,r,a){var n=this._getParser();this.loader.setMimeType(void 0).setResponseType("arraybuffer").load(e,function(e){t(n.parsePmd(e,!0))},r,a)},loadPMX:function(e,t,r,a){var n=this._getParser();this.loader.setMimeType(void 0).setResponseType("arraybuffer").load(e,function(e){t(n.parsePmx(e,!0))},r,a)},loadVMD:function(e,t,r,a){var n=Array.isArray(e)?e:[e],i=[],o=n.length,s=this._getParser();this.loader.setMimeType(void 0).setResponseType("arraybuffer");for(var u=0,d=n.length;u<d;u++)this.loader.load(n[u],function(e){i.push(s.parseVmd(e,!0)),i.length===o&&t(s.mergeVmds(i))},r,a)},loadVPD:function(e,t,r,a,n,i){i=i||{};var o=this._getParser();this.loader.setMimeType(t?void 0:"text/plain; charset=shift_jis").setResponseType("text").load(e,function(e){r(o.parseVpd(e,!0))},a,n)},_extractExtension:function(e){var t=e.lastIndexOf(".");return t<0?"":e.slice(t+1)},_getParser:function(){if(null===this.parser){if("undefined"==typeof MMDParser)throw new Error("THREE.MMDLoader: Import MMDParser https://github.com/takahirox/mmd-parser");this.parser=new MMDParser.Parser}return this.parser}};var u=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/bWiiMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh8aBHZBl14e8wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOUlEQVRYR+3WMREAMAwDsYY/yoDI7MLwIiP40+RJklfcCCBAgAABAgTqArfb/QMCCBAgQIAAgbbAB3z/e0F3js2cAAAAAElFTkSuQmCC","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAN0lEQVRYR+3WQREAMBACsZ5/B5ilMvgEBTt5cW37hjsBBAgQIECAwFwgyfYPCCBAgAABAgTWAh81dWyx0gFwKAAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAOklEQVRYR+3WoREAMAwDsWb/UQtCy9wxTOQJ/oQ8SXKKGwEECBAgQIBAXeDt7f4BAQQIECBAgEBb4AOz8Hzx7WLY4wAAAABJRU5ErkJggg==","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABPUlEQVRYR+1XwW7CMAy1+f9fZOMysSEOEweEOPRNdm3HbdOyIhAcklPrOs/PLy9RygBALxzcCDQFmgJNgaZAU6Ap0BR4PwX8gsRMVLssMRH5HcpzJEaWL7EVg9F1IHRlyqQohgVr4FGUlUcMJSjcUlDw0zvjeun70cLWmneoyf7NgBTQSniBTQQSuJAZsOnnaczjIMb5hCiuHKxokCrJfVnrctyZL0PkJAJe1HMil4nxeyi3Ypfn1kX51jpPvo/JeCNC4PhVdHdJw2XjBR8brF8PEIhNVn12AgP7uHsTBguBn53MUZCqv7Lp07Pn5k1Ro+uWmUNn7D+M57rtk7aG0Vo73xyF/fbFf0bPJjDXngnGocDTdFhygZjwUQrMNrDcmZlQT50VJ/g/UwNyHpu778+yW+/ksOz/BFo54P4AsUXMfRq7XWsAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAACMElEQVRYR+2Xv4pTQRTGf2dubhLdICiii2KnYKHVolhauKWPoGAnNr6BD6CvIVaihYuI2i1ia0BY0MZGRHQXjZj/mSPnnskfNWiWZUlzJ5k7M2cm833nO5Mziej2DWWJRUoCpQKlAntSQCqgw39/iUWAGmh37jrRnVsKlgpiqmkoGVABA7E57fvY+pJDdgKqF6HzFCSADkDq+F6AHABtQ+UMVE5D7zXod7fFNhTEckTbj5XQgHzNN+5tQvc5NG7C6BNkp6D3EmpXHDR+dQAjFLchW3VS9rlw3JBh+B7ys5Cf9z0GW1C/7P32AyBAOAz1q4jGliIH3YPuBnSfQX4OGreTIgEYQb/pBDtPnEQ4CivXYPAWBk13oHrB54yA9QuSn2H4AcKRpEILDt0BUzj+RLR1V5EqjD66NPRBVpLcQwjHoHYJOhsQv6U4mnzmrIXJCFr4LDwm/xBUoboG9XX4cc9VKdYoSA2yk5NQLJaKDUjTBoveG3Z2TElTxwjNK4M3LEZgUdDdruvcXzKBpStgp2NPiWi3ks9ZXxIoFVi+AvHLdc9TqtjL3/aYjpPlrzOcEnK62Szhimdd7xX232zFDTgtxezOu3WNMRLjiKgjtOhHVMd1loynVHvOgjuIIJMaELEqhJAV/RCSLbWTcfPFakFgFlALTRRvx+ok6Hlp/Q+v3fmx90bMyUzaEAhmM3KvHlXTL5DxnbGf/1M8RNNACLL5MNtPxP/mypJAqcDSFfgFhpYqWUzhTEAAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAL0lEQVRYR+3QQREAAAzCsOFfNJPBJ1XQS9r2hsUAAQIECBAgQIAAAQIECBAgsBZ4MUx/ofm2I/kAAAAASUVORK5CYII="];return t.prototype={constructor:t,crossOrigin:void 0,setCrossOrigin:function(e){return this.crossOrigin=e,this},build:function(e,t,r,a){var n=this.geometryBuilder.build(e),i=this.materialBuilder.setCrossOrigin(this.crossOrigin).setTexturePath(t).build(e,n,r,a),o=new s.SkinnedMesh(n,i);return o}},r.prototype={constructor:r,build:function(e){function t(t,r,a){for(var n=0;n<r.elementCount;n++){var i,o=r.elements[n];i="pmd"===e.metadata.format?e.morphs[0].elements[o.index].index:o.index,t.array[3*i+0]+=o.position[0]*a,t.array[3*i+1]+=o.position[1]*a,t.array[3*i+2]+=o.position[2]*a}}for(var r=[],a=[],n=[],i=[],o=[],u=[],d=[],l=[],A=[],f=[],h=[],p=[],c=[],g=[],m=0,v={},b=0;b<e.metadata.vertexCount;b++){for(var y=e.vertices[b],x=0,C=y.position.length;x<C;x++)r.push(y.position[x]);for(var x=0,C=y.normal.length;x<C;x++)n.push(y.normal[x]);for(var x=0,C=y.uv.length;x<C;x++)a.push(y.uv[x]);for(var x=0;x<4;x++)d.push(y.skinIndices.length-1>=x?y.skinIndices[x]:0);for(var x=0;x<4;x++)l.push(y.skinWeights.length-1>=x?y.skinWeights[x]:0)}for(var b=0;b<e.metadata.faceCount;b++)for(var B=e.faces[b],x=0,C=B.indices.length;x<C;x++)i.push(B.indices[x]);for(var b=0;b<e.metadata.materialCount;b++){var E=e.materials[b];o.push({offset:3*m,count:3*E.faceCount}),m+=E.faceCount}for(var b=0;b<e.metadata.rigidBodyCount;b++){var w=e.rigidBodies[b],T=v[w.boneIndex];T=void 0===T?w.type:Math.max(w.type,T),v[w.boneIndex]=T}for(var b=0;b<e.metadata.boneCount;b++){var I=e.bones[b],M={parent:I.parentIndex,name:I.name,pos:I.position.slice(0,3),rotq:[0,0,0,1],scl:[1,1,1],rigidBodyType:void 0!==v[b]?v[b]:-1};M.parent!==-1&&(M.pos[0]-=e.bones[M.parent].position[0],M.pos[1]-=e.bones[M.parent].position[1],M.pos[2]-=e.bones[M.parent].position[2]),u.push(M)}if("pmd"===e.metadata.format)for(var b=0;b<e.metadata.ikCount;b++){for(var R=e.iks[b],k={target:R.target,effector:R.effector,iteration:R.iteration,maxAngle:4*R.maxAngle,links:[]},x=0,C=R.links.length;x<C;x++){var L={};L.index=R.links[x].index,L.enabled=!0,e.bones[L.index].name.indexOf("ひざ")>=0&&(L.limitation=new s.Vector3(1,0,0)),k.links.push(L)}h.push(k)}else for(var b=0;b<e.metadata.boneCount;b++){var R=e.bones[b].ik;if(void 0!==R){for(var k={target:b,effector:R.effector,iteration:R.iteration,maxAngle:R.maxAngle,links:[]},x=0,C=R.links.length;x<C;x++){var L={};if(L.index=R.links[x].index,L.enabled=!0,1===R.links[x].angleLimitation){var O=R.links[x].lowerLimitationAngle,P=R.links[x].upperLimitationAngle,Q=-P[0],S=-P[1];P[0]=-O[0],P[1]=-O[1],O[0]=Q,O[1]=S,L.rotationMin=(new s.Vector3).fromArray(O),L.rotationMax=(new s.Vector3).fromArray(P)}k.links.push(L)}h.push(k)}}if("pmx"===e.metadata.format){for(var b=0;b<e.metadata.boneCount;b++){var I=e.bones[b],U=I.grant;if(void 0!==U){var k={index:b,parentIndex:U.parentIndex,ratio:U.ratio,isLocal:U.isLocal,affectRotation:U.affectRotation,affectPosition:U.affectPosition,transformationClass:I.transformationClass};p.push(k)}}p.sort(function(e,t){return e.transformationClass-t.transformationClass})}for(var b=0;b<e.metadata.morphCount;b++){var V=e.morphs[b],_={name:V.name},D=new s.Float32BufferAttribute(3*e.metadata.vertexCount,3);D.name=V.name;for(var x=0;x<3*e.metadata.vertexCount;x++)D.array[x]=r[x];if("pmd"===e.metadata.format)0!==b&&t(D,V,1);else if(0===V.type)for(var x=0;x<V.elementCount;x++){var F=e.morphs[V.elements[x].index],N=V.elements[x].ratio;1===F.type&&t(D,F,N)}else 1===V.type&&t(D,V,1);A.push(_),f.push(D)}for(var b=0;b<e.metadata.rigidBodyCount;b++){var z=e.rigidBodies[b],_={};for(var Y in z)_[Y]=z[Y];if("pmx"===e.metadata.format&&_.boneIndex!==-1){var M=e.bones[_.boneIndex];_.position[0]-=M.position[0],_.position[1]-=M.position[1],_.position[2]-=M.position[2]}c.push(_)}for(var b=0;b<e.metadata.constraintCount;b++){var j=e.constraints[b],_={};for(var Y in j)_[Y]=j[Y];var K=c[_.rigidBodyIndex1],H=c[_.rigidBodyIndex2];0!==K.type&&2===H.type&&K.boneIndex!==-1&&H.boneIndex!==-1&&e.bones[H.boneIndex].parentIndex===K.boneIndex&&(H.type=1),g.push(_)}var J=new s.BufferGeometry;J.addAttribute("position",new s.Float32BufferAttribute(r,3)),J.addAttribute("normal",new s.Float32BufferAttribute(n,3)),J.addAttribute("uv",new s.Float32BufferAttribute(a,2)),J.addAttribute("skinIndex",new s.Uint16BufferAttribute(d,4)),J.addAttribute("skinWeight",new s.Float32BufferAttribute(l,4)),J.setIndex(i);for(var b=0,W=o.length;b<W;b++)J.addGroup(o[b].offset,o[b].count,b);return J.bones=u,J.morphTargets=A,J.morphAttributes.position=f,J.userData.MMD={bones:u,iks:h,grants:p,rigidBodies:c,constraints:g,format:e.metadata.format},J.computeBoundingSphere(),J}},n.prototype={constructor:n,crossOrigin:void 0,texturePath:void 0,setCrossOrigin:function(e){return this.crossOrigin=e,this},setTexturePath:function(e){return this.texturePath=e,this},build:function(e,t,r,a){var n=[],i={};this.textureLoader.setCrossOrigin(this.crossOrigin);for(var o=0;o<e.metadata.materialCount;o++){var u=e.materials[o],d={userData:{}};if(void 0!==u.name&&(d.name=u.name),d.color=(new s.Color).fromArray(u.diffuse),d.opacity=u.diffuse[3],d.specular=(new s.Color).fromArray(u.specular),d.emissive=(new s.Color).fromArray(u.ambient),d.shininess=Math.max(u.shininess,1e-4),d.transparent=1!==d.opacity,d.skinning=t.bones.length>0,d.morphTargets=t.morphTargets.length>0,d.lights=!0,d.fog=!0,d.blending=s.CustomBlending,d.blendSrc=s.SrcAlphaFactor,d.blendDst=s.OneMinusSrcAlphaFactor,d.blendSrcAlpha=s.SrcAlphaFactor,d.blendDstAlpha=s.DstAlphaFactor,d.side="pmx"===e.metadata.format&&1===(1&u.flag)?s.DoubleSide:1===d.opacity?s.FrontSide:s.DoubleSide,"pmd"===e.metadata.format){if(u.fileName){var l=u.fileName,A=l.split("*");if(d.map=this._loadTexture(A[0],i),A.length>1){var f=A[1].slice(-4).toLowerCase();d.envMap=this._loadTexture(A[1],i,{sphericalReflectionMapping:!0}),d.combine=".sph"===f?s.MultiplyOperation:s.AddOperation}}var h=u.toonIndex===-1?"toon00.bmp":e.toonTextures[u.toonIndex].fileName;d.gradientMap=this._loadTexture(h,i,{isToonTexture:!0,isDefaultToonTexture:this._isDefaultToonTexture(h)}),d.userData.outlineParameters={thickness:1===u.edgeFlag?.003:0,color:[0,0,0],alpha:1,visible:1===u.edgeFlag}}else{u.textureIndex!==-1&&(d.map=this._loadTexture(e.textures[u.textureIndex],i)),u.envTextureIndex===-1||1!==u.envFlag&&2!=u.envFlag||(d.envMap=this._loadTexture(e.textures[u.envTextureIndex],i,{sphericalReflectionMapping:!0}),d.combine=1===u.envFlag?s.MultiplyOperation:s.AddOperation);var h,p;u.toonIndex===-1||0!==u.toonFlag?(h="toon"+("0"+(u.toonIndex+1)).slice(-2)+".bmp",p=!0):(h=e.textures[u.toonIndex],p=!1),d.gradientMap=this._loadTexture(h,i,{isToonTexture:!0,isDefaultToonTexture:p}),d.userData.outlineParameters={thickness:u.edgeSize/300,color:u.edgeColor.slice(0,3),alpha:u.edgeColor[3],visible:0!==(16&u.flag)&&u.edgeSize>0}}void 0!==d.map&&(d.transparent||this._checkImageTransparency(d.map,t,o),d.emissive.multiplyScalar(.2)),n.push(new s.MeshToonMaterial(d))}if("pmx"===e.metadata.format)for(var c=function(e,t){for(var r=0,a=e.length;r<a;r++){var n=e[r];if(n.index!==-1){var i=t[n.index];i.opacity!==n.diffuse[3]&&(i.transparent=!0)}}},o=0,g=e.morphs.length;o<g;o++){var m=e.morphs[o],v=m.elements;if(0===m.type)for(var b=0,y=v.length;b<y;b++){var x=e.morphs[v[b].index];8===x.type&&c(x.elements,n)}else 8===m.type&&c(v,n)}return n},_getTGALoader:function(){if(null===this.tgaLoader){if(void 0===s.TGALoader)throw new Error("THREE.MMDLoader: Import THREE.TGALoader");this.tgaLoader=new s.TGALoader(this.manager)}return this.tgaLoader},_isDefaultToonTexture:function(e){return 10===e.length&&/toon(10|0[0-9])\.bmp/.test(e)},_loadTexture:function(e,t,r,a,n){r=r||{};var i,o=this;if(r.isDefaultToonTexture===!0){var d;try{d=parseInt(e.match("toon([0-9]{2}).bmp$")[1])}catch(t){console.warn("THREE.MMDLoader: "+e+" seems like a not right default texture path. Using toon00.bmp instead."),d=0}i=u[d]}else i=this.texturePath+e;if(void 0!==t[i])return t[i];var l=s.Loader.Handlers.get(i);null===l&&(l=".tga"===e.slice(-4).toLowerCase()?this._getTGALoader():this.textureLoader);var A=l.load(i,function(e){r.isToonTexture===!0&&(e.image=o._getRotatedImage(e.image)),e.flipY=!1,e.wrapS=s.RepeatWrapping,e.wrapT=s.RepeatWrapping;for(var t=0;t<A.readyCallbacks.length;t++)A.readyCallbacks[t](A);delete A.readyCallbacks},a,n);return r.sphericalReflectionMapping===!0&&(A.mapping=s.SphericalReflectionMapping),A.readyCallbacks=[],t[i]=A,A},_getRotatedImage:function(e){var t=document.createElement("canvas"),r=t.getContext("2d"),a=e.width,n=e.height;return t.width=a,t.height=n,r.clearRect(0,0,a,n),r.translate(a/2,n/2),r.rotate(.5*Math.PI),r.translate(-a/2,-n/2),r.drawImage(e,0,0),r.getImageData(0,0,a,n)},_checkImageTransparency:function(e,t,r){e.readyCallbacks.push(function(a){function n(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var r=t.getContext("2d");return r.drawImage(e,0,0),r.getImageData(0,0,t.width,t.height)}function i(e,t,r){var a=e.width,n=e.height,i=e.data,s=253;if(i.length/(a*n)!==4)return!1;for(var u=0;u<r.length;u+=3){for(var d={x:0,y:0},l=0;l<3;l++){var A=r[3*u+l],f={x:t[2*A+0],y:t[2*A+1]};if(o(e,f)<s)return!0;d.x+=f.x,d.y+=f.y}if(d.x/=3,d.y/=3,o(e,d)<s)return!0}return!1}function o(e,t){var r=e.width,a=e.height,n=Math.round(t.x*r)%r,i=Math.round(t.y*a)%a;n<0&&(n+=r),i<0&&(i+=a);var o=i*r+n;return e.data[4*o+3]}var s=void 0!==a.image.data?a.image:n(a.image),u=t.groups[r];i(s,t.attributes.uv.array,t.index.array.slice(u.start,u.start+u.count))&&(e.transparent=!0)})}},i.prototype={constructor:i,build:function(e,t){for(var r=this.buildSkeletalAnimation(e,t).tracks,a=this.buildMorphAnimation(e,t).tracks,n=0,i=a.length;n<i;n++)r.push(a[n]);return new s.AnimationClip("",-1,r)},buildSkeletalAnimation:function(e,t){function r(e,t,r){e.push(t[r+0]/127),e.push(t[r+8]/127),e.push(t[r+4]/127),e.push(t[r+12]/127)}for(var a=[],n={},i=t.skeleton.bones,o={},u=0,d=i.length;u<d;u++)o[i[u].name]=!0;for(var u=0;u<e.metadata.motionCount;u++){var l=e.motions[u],A=l.boneName;void 0!==o[A]&&(n[A]=n[A]||[],n[A].push(l))}for(var f in n){var h=n[f];h.sort(function(e,t){return e.frameNum-t.frameNum});for(var p=[],c=[],g=[],m=[],v=[],b=t.skeleton.getBoneByName(f).position.toArray(),u=0,d=h.length;u<d;u++){var y=h[u].frameNum/30,x=h[u].position,C=h[u].rotation,B=h[u].interpolation;p.push(y);for(var E=0;E<3;E++)c.push(b[E]+x[E]);for(var E=0;E<4;E++)g.push(C[E]);for(var E=0;E<3;E++)r(m,B,E);r(v,B,3)}var w=".bones["+f+"]";a.push(this._createTrack(w+".position",s.VectorKeyframeTrack,p,c,m)),a.push(this._createTrack(w+".quaternion",s.QuaternionKeyframeTrack,p,g,v))}return new s.AnimationClip("",-1,a)},buildMorphAnimation:function(e,t){for(var r=[],a={},n=t.morphTargetDictionary,i=0;i<e.metadata.morphCount;i++){var o=e.morphs[i],u=o.morphName;void 0!==n[u]&&(a[u]=a[u]||[],a[u].push(o))}for(var d in a){var l=a[d];l.sort(function(e,t){return e.frameNum-t.frameNum});for(var A=[],f=[],i=0,h=l.length;i<h;i++)A.push(l[i].frameNum/30),f.push(l[i].weight);r.push(new s.NumberKeyframeTrack(".morphTargetInfluences["+n[d]+"]",A,f))}return new s.AnimationClip("",-1,r)},buildCameraAnimation:function(e){function t(e,t){e.push(t.x),e.push(t.y),e.push(t.z)}function r(e,t){e.push(t.x),e.push(t.y),e.push(t.z),e.push(t.w)}function a(e,t,r){e.push(t[4*r+0]/127),e.push(t[4*r+1]/127),e.push(t[4*r+2]/127),e.push(t[4*r+3]/127)}var n=[],i=void 0===e.cameras?[]:e.cameras.slice();i.sort(function(e,t){return e.frameNum-t.frameNum});for(var o=[],u=[],d=[],l=[],A=[],f=[],h=[],p=[],c=[],g=new s.Quaternion,m=new s.Euler,v=new s.Vector3,b=new s.Vector3,y=0,x=i.length;y<x;y++){var C=i[y],B=C.frameNum/30,E=C.position,w=C.rotation,T=C.distance,I=C.fov,M=C.interpolation;o.push(B),v.set(0,0,-T),b.set(E[0],E[1],E[2]),m.set(-w[0],-w[1],-w[2]),g.setFromEuler(m),v.add(b),v.applyQuaternion(g),t(u,b),r(d,g),t(l,v),A.push(I);for(var R=0;R<3;R++)a(f,M,R);a(h,M,3);for(var R=0;R<3;R++)a(p,M,4);a(c,M,5)}var n=[];return n.push(this._createTrack("target.position",s.VectorKeyframeTrack,o,u,f)),n.push(this._createTrack(".quaternion",s.QuaternionKeyframeTrack,o,d,h)),n.push(this._createTrack(".position",s.VectorKeyframeTrack,o,l,p)),n.push(this._createTrack(".fov",s.NumberKeyframeTrack,o,A,c)),new s.AnimationClip("",-1,n)},_createTrack:function(e,t,r,a,n){if(r.length>2){r=r.slice(),a=a.slice(),n=n.slice();for(var i=a.length/r.length,s=n.length/r.length,u=1,d=2,l=r.length;d<l;d++){for(var A=0;A<i;A++)if(a[u*i+A]!==a[(u-1)*i+A]||a[u*i+A]!==a[d*i+A]){u++;break}if(d>u){r[u]=r[d];for(var A=0;A<i;A++)a[u*i+A]=a[d*i+A];for(var A=0;A<s;A++)n[u*s+A]=n[d*s+A]}}r.length=u+1,a.length=(u+1)*i,n.length=(u+1)*s}var f=new t(e,r,a);return f.createInterpolant=function(e){return new o(this.times,this.values,this.getValueSize(),e,new Float32Array(n))},f}},o.prototype=a(Object.create(s.Interpolant.prototype),{constructor:o,interpolate_:function(e,t,r,a){var n=this.resultBuffer,i=this.sampleValues,o=this.valueSize,u=this.interpolationParams,d=e*o,l=d-o,A=a-t<.05?0:(r-t)/(a-t);if(4===o){var f=u[4*e+0],h=u[4*e+1],p=u[4*e+2],c=u[4*e+3],g=this._calculate(f,h,p,c,A);s.Quaternion.slerpFlat(n,0,i,l,i,d,g)}else if(3===o)for(var m=0;m!==o;++m){var f=u[12*e+4*m+0],h=u[12*e+4*m+1],p=u[12*e+4*m+2],c=u[12*e+4*m+3],g=this._calculate(f,h,p,c,A);n[m]=i[l+m]*(1-g)+i[d+m]*g}else{var f=u[4*e+0],h=u[4*e+1],p=u[4*e+2],c=u[4*e+3],g=this._calculate(f,h,p,c,A);n[0]=i[l]*(1-g)+i[d]*g}return n},_calculate:function(e,t,r,a,n){for(var i,o,s,u=.5,d=u,l=1-d,A=15,f=1e-5,h=Math,p=0;p<A;p++){i=3*l*l*d,o=3*l*d*d,s=d*d*d;var c=i*e+o*t+s-n;if(h.abs(c)<f)break;u/=2,d+=c<0?u:-u,l=1-d}return i*r+o*a+s}}),e}()},88:function(e,t,r){"use strict";function a(e){return e&&e.__esModule?e:{default:e}}var n=r(23),i=r(64),o=a(i),s="undefined"!=typeof window,u={FileLoader:n.FileLoader,MMDLoader:o.default};s&&window.Easycanvas?Easycanvas.threeLoaders=u:e.exports=u}})});