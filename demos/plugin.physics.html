<head>
    <script src="../build/index.js"></script>
    <script src="../build/plugin.physics.js"></script>
</head>

<script>
    window.onerror = function () {
        alert(arguments[0]);
        alert(arguments[1]);
        alert(arguments[2]);
    };
</script>

<style>
    body {
        margin: 10px;
    }
    canvas {
        border: 1px solid grey;
    }
</style>
<body>
    <canvas id="foo"></canvas>
</body>

<script>
    var width = document.body.clientWidth - 20, height = document.body.clientHeight - 20;

    var $Painter = new Easycanvas.painter();
    $Painter.register(document.getElementById('foo'), {
        width: width,
        height: height,
    });
    $Painter.start();

    var BALL = Easycanvas.imgLoader('https://raw.githubusercontent.com/chenzhuo1992/easycanvas/master/demos/G.png');
    var BLOCK = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC4AAAAwCAYAAABuZUjcAAAAlElEQVRoBe3SwQmAQBDFUNe6PNmC/deiYAU5hIWBeA6f4a3rup/3GPidA2/+T+7w3S+XeOJQoF8FQmlZ4holHEocQmlZ4holHEocQmlZ4holHEocQmlZ4holHEocQmlZ4holHEocQmlZ4holHEocQmlZ4holHEocQmlZ4holHEocQmlZ4holHEocQmlZ4holHBor/gGBBgIwevtkRgAAAABJRU5ErkJggg==';

    var opacity = 0.5;
    opacity = 1;

    // 创建一个物理对象，内部重力为1（“内部”的意思是这个东西本身不受重力影响，不会掉下去，作为容器）
    window.$space = new Easycanvas.class.sprite({
        style: {
            // tx: 50,
        },
        physics: {
            gravity: 0.01,
        },
    });

    $Painter.add($space);
    $space.launch().addCollisionHandler(
        1, 2,
        function (cp) {
            return true;
        },
        function () {
            // console.log(2);
            return true;
        },
        function () {
            // console.log(3);
            return false;
        },
        function (cp) {
            var sq = cp.b.$sprite.name === 'square' ? cp.b.$sprite : cp.b.$sprite;
            var ball = cp.a.$sprite.name === 'square' ? cp.a.$sprite : cp.a.$sprite;

            sq.children[0].content.text--;
            if (!sq.children[0].content.text) {
                sq.style.visible = false;
                $Painter.nextTick(() => {
                    sq.physicsOff();
                    sq.remove();
                });
            }
            return false;
        }
    );

    var ballSize = 30;
    var ballArray = [];
    function addBall () {
        // 创建一个球体
        var ballSprite = new Easycanvas.class.sprite({
            name: 'ball',
            content: {
                // 这个图是个字母G，形状类似一个球。（为什么不用字母O呢？因为字母O太圆了，看不出来旋转）
                img: BALL,
            },
            physics: {
                // 形状是一个以(10,10)为圆心的，半径10的圆
                shape: [
                    [ballSize/2, ballSize/2, ballSize/2 + 2]
                ],
                mass: 0.1, // 质量
                friction: 0, // 摩擦，如果摩擦为0，他会在地上滚个不停
                elasticity: 1, // 弹性，如果弹性为0，掉地上了就再也弹不起来了（1的话就弹个不停）
                collisionType: 1,
            },
            style: {
                tw: ballSize, th: ballSize, // 图片宽高都是ballSize，确保了图片大小和物理形状是吻合的（看起来才逼真）
                sx: 0, sy: 0,
                tx: Math.floor(Math.random() * 300) + 1,
                ty: Math.floor(Math.random() * 20) + 1,
                locate: 'lt',
                zIndex: 1,
                opacity: opacity,
            },
        });
        $space.add(ballSprite);
        ballSprite.physicsOn();
        ballArray.push(ballSprite);
    }
    addBall();

    var ballCount = 0;
    setInterval(() => {
        if (ballCount > 20) return;

        addBall();
        ballCount++;
    }, 200);

    // 创建一个方形物体（是个酒店的床型照片）
    function addSq () {
        var deg = Math.floor(Math.random() * 360);
        var sqSprite = $space.add(new Easycanvas.class.sprite({
            name: 'square',
            content: {
                img: BLOCK,
            },
            physics: {
                // 形状是这4个坐标点围成的矩形（因为这个图片是矩形，为了看起来吻合）
                shape: [
                    [[0, 0], [0, 30]],
                    [[0, 30], [30, 30]],
                    [[30, 30], [30, 0]],
                    [[30, 0], [0, 0]]
                    // [0, 0], [30, 0], [30, 30], [0, 30], [0, 0]
                ],
                mass: 0.1, // 质量比球大
                friction: 0,
                elasticity: 1,
                collisionType: 2,
                static: true,
            },
            style: {
                tw: 30, th: 30,
                tx: Math.floor(Math.random() * (width - 100)) + 50,
                ty: Math.floor(Math.random() * (height - 300)) + 200,
                locate: 'lt',
                zIndex: Math.random(),
                opacity: opacity,
                rotate: deg,
            },
            children: [{
                content: {
                    text: Math.floor(Math.random() * 20) + 1,
                },
                style: {
                    color: 'yellow',
                    textAlign: 'center',
                    textVerticalAlign: 'middle',
                    textFont: '28px Arial',
                    tx: 15, ty: 10
                }
            }]
        }));
        sqSprite.physicsOn();
    }

    for (var i = 0; i < 20; i += 1) {
        addSq();
    }

    // 创建一个静态的东西，做障碍，给球撞的，我随便找了一个“快领红包”的按钮
    // window.staticSprite = $space.add(new Easycanvas.class.sprite({
    //     name: 'line-static',
    //     content: {
    //         img: Btn,
    //     },
    //     physics: {
    //         // 形状是一个线段（只弄了一条边（上面的边），毕竟另外几条没用到，因为没撞到其他物体）
    //         shape: [
    //             [[30, 30], [170, 30]],
    //         ],
    //         friction: 0.1,
    //         elasticity: 0.4,
    //         // 这个元素是静态的（不受重力影响，不会被撞飞）
    //         static: true,
    //         collisionType: 3,
    //     },
    //     style: {
    //         tw: 200, th: 120,
    //         sx: 0, sy: 0,
    //         tx: 100,
    //         ty: 300,
    //         rx: 200, ry: 360,
    //         rotate: -10,
    //         locate: 'center',
    //         zIndex: 2,
    //         opacity: opacity,
    //     },
    // }));
    // staticSprite.physicsOn();

    // 这个是边界（不然球会掉到屏幕外）
    window.borderSprite = $space.add(new Easycanvas.class.sprite({
        name: 'border-static',
        content: {
        },
        physics: {
            // 围成了一个矩形（4个线段组成的形状，是个空心的，用来做边界）
            shape: [
                [[0, 0], [width, 0]],
                [[0, 0], [0, height]],
                [[width, 0], [width, height]],
                [[0, height], [width, height]]
            ],
            friction: 0.1,
            elasticity: 0.8,
            // 这个元素是静态的（不受重力影响，不会被撞飞）
            static: true
        },
        style: {
            tx: 0, ty: 0, tw: width, th: height,
            locate: 'lt',
            opacity: opacity,
        },
    }));

    borderSprite.physicsOn();

    window.addEventListener('deviceorientation', function (evt) {
        var right = Math.floor(evt.gamma);
        var down = Math.floor(evt.beta - 30);

        ballArray.forEach(function ($sprite) {
            if (!$sprite.$physics) return;
            $sprite.$physics.body.resetForces();
            $sprite.$physics.body.applyForce(new cp.Vect(right, -down * 1.2), new cp.Vect(0,0));
        });
    });
    // $es.$physics.body.resetForces();
</script>